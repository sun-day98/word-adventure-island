<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯å›¾é‰´ - å•è¯å†’é™©å²›</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/word-adventure.css">
</head>
<body>
    <div class="page-container word-book-page">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <header class="page-header">
            <h1>ğŸ“– å•è¯å›¾é‰´</h1>
            <div class="header-stats">
                <span class="stat-item">å·²å­¦: <span id="learned-count">0</span></span>
                <span class="stat-item">æŒæ¡: <span id="mastered-count">0</span></span>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- æœç´¢å’Œç­›é€‰ -->
            <section class="search-filter-section">
                <div class="search-bar">
                    <input type="text" 
                           id="word-search" 
                           placeholder="æœç´¢å•è¯..." 
                           onkeyup="searchWords()">
                    <button class="search-btn" onclick="searchWords()">ğŸ”</button>
                </div>
                
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="all" onclick="filterWords('all')">å…¨éƒ¨</button>
                    <button class="filter-tab" data-filter="learning" onclick="filterWords('learning')">å­¦ä¹ ä¸­</button>
                    <button class="filter-tab" data-filter="reviewing" onclick="filterWords('reviewing')">éœ€è¦å¤ä¹ </button>
                    <button class="filter-tab" data-filter="mastered" onclick="filterWords('mastered')">å·²æŒæ¡</button>
                </div>
                
                <div class="difficulty-filter">
                    <select id="difficulty-select" onchange="filterByDifficulty()">
                        <option value="all">æ‰€æœ‰éš¾åº¦</option>
                        <option value="beginner">åˆçº§ (1-2å¹´çº§)</option>
                        <option value="intermediate">ä¸­çº§ (3-4å¹´çº§)</option>
                        <option value="advanced">é«˜çº§ (5-6å¹´çº§)</option>
                    </select>
                </div>
            </section>

            <!-- å•è¯åˆ—è¡¨ -->
            <section class="word-list-section">
                <div class="word-stats-summary">
                    <div class="summary-card">
                        <div class="summary-icon">ğŸ“š</div>
                        <div class="summary-info">
                            <div class="summary-number" id="total-words">0</div>
                            <div class="summary-label">æ€»å•è¯æ•°</div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">ğŸ“ˆ</div>
                        <div class="summary-info">
                            <div class="summary-number" id="today-words">0</div>
                            <div class="summary-label">ä»Šæ—¥å­¦ä¹ </div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">ğŸ”„</div>
                        <div class="summary-info">
                            <div class="summary-number" id="review-words">0</div>
                            <div class="summary-label">å¾…å¤ä¹ </div>
                        </div>
                    </div>
                </div>

                <div class="word-list" id="word-list">
                    <!-- å•è¯å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>
        </main>
    </div>

    <!-- å•è¯è¯¦æƒ…å¼¹çª— -->
    <div id="word-detail-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content word-detail-modal">
            <div class="word-detail-header">
                <button class="close-btn" onclick="closeWordDetail()">Ã—</button>
            </div>
            <div class="word-detail-content" id="word-detail-content">
                <!-- å•è¯è¯¦æƒ…å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="word-detail-actions">
                <button class="secondary-btn" onclick="playWordAudio()">ğŸ”Š æ’­æ”¾å‘éŸ³</button>
                <button class="primary-btn" onclick="startWordPractice()">å¼€å§‹ç»ƒä¹ </button>
            </div>
        </div>
    </div>

    <script>
        // å½“å‰æ˜¾ç¤ºçš„å•è¯åˆ—è¡¨
        let currentWords = [];
        let currentFilter = 'all';
        let currentDifficulty = 'all';
        let currentWordDetail = null;

        // ===== é¡µé¢åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeWordBook();
        });

        async function initializeWordBook() {
            // ç­‰å¾…æ¸¸æˆå¼•æ“åˆå§‹åŒ–
            if (typeof WordAdventure === 'undefined') {
                setTimeout(initializeWordBook, 100);
                return;
            }

            loadWordList();
            updateStatistics();
            setupEventListeners();
        }

        // ===== åŠ è½½å•è¯åˆ—è¡¨ =====
        function loadWordList() {
            // è·å–æ‰€æœ‰å•è¯æ•°æ®
            const allWords = [];
            
            for (const difficulty in WordAdventureData.WordDatabase) {
                WordAdventureData.WordDatabase[difficulty].forEach(word => {
                    allWords.push({
                        ...word,
                        difficulty: difficulty,
                        status: getWordStatus(word.id)
                    });
                });
            }

            currentWords = allWords;
            renderWordList(currentWords);
        }

        function getWordStatus(wordId) {
            const gameState = WordAdventure.gameState;
            
            if (gameState.learning.learnedWords.includes(wordId)) {
                const mastery = WordAdventure.calculateMasteryLevel(wordId);
                if (mastery >= 4) return 'mastered';
                return 'learning';
            }
            
            const reviewingWords = gameState.learning.reviewingWords;
            if (reviewingWords.find(review => review.wordId === wordId)) {
                return 'reviewing';
            }
            
            return 'new';
        }

        function renderWordList(words) {
            const wordList = document.getElementById('word-list');
            
            if (words.length === 0) {
                wordList.innerHTML = '<div class="empty-state">æš‚æ— å•è¯</div>';
                return;
            }

            let html = '';
            words.forEach(word => {
                html += createWordCard(word);
            });

            wordList.innerHTML = html;
        }

        function createWordCard(word) {
            const statusColors = {
                'new': '#e9ecef',
                'learning': '#fff3cd',
                'reviewing': '#cce5ff',
                'mastered': '#d4edda'
            };

            const statusTexts = {
                'new': 'æ–°å•è¯',
                'learning': 'å­¦ä¹ ä¸­',
                'reviewing': 'éœ€å¤ä¹ ',
                'mastered': 'å·²æŒæ¡'
            };

            const difficultyTexts = {
                'beginner': 'åˆçº§',
                'intermediate': 'ä¸­çº§',
                'advanced': 'é«˜çº§'
            };

            return `
                <div class="word-card ${word.status}" onclick="showWordDetail('${word.id}')">
                    <div class="word-card-header">
                        <div class="word-main">${word.word}</div>
                        <div class="word-status" style="background: ${statusColors[word.status]}">
                            ${statusTexts[word.status]}
                        </div>
                    </div>
                    <div class="word-phonetic">${word.pronunciation}</div>
                    <div class="word-chinese">${word.chinese}</div>
                    <div class="word-card-footer">
                        <span class="word-difficulty ${word.difficulty}">${difficultyTexts[word.difficulty]}</span>
                        <span class="word-grade">${word.grade}å¹´çº§</span>
                    </div>
                </div>
            `;
        }

        // ===== æœç´¢å’Œç­›é€‰ =====
        function searchWords() {
            const searchTerm = document.getElementById('word-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderWordList(currentWords);
                return;
            }

            const filteredWords = currentWords.filter(word => 
                word.word.toLowerCase().includes(searchTerm) ||
                word.chinese.includes(searchTerm) ||
                word.mnemonic.toLowerCase().includes(searchTerm)
            );

            renderWordList(filteredWords);
        }

        function filterWords(filter) {
            currentFilter = filter;
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

            applyFilters();
        }

        function filterByDifficulty() {
            currentDifficulty = document.getElementById('difficulty-select').value;
            applyFilters();
        }

        function applyFilters() {
            let filteredWords = [...currentWords];

            // çŠ¶æ€ç­›é€‰
            if (currentFilter !== 'all') {
                filteredWords = filteredWords.filter(word => word.status === currentFilter);
            }

            // éš¾åº¦ç­›é€‰
            if (currentDifficulty !== 'all') {
                filteredWords = filteredWords.filter(word => word.difficulty === currentDifficulty);
            }

            renderWordList(filteredWords);
        }

        // ===== å•è¯è¯¦æƒ… =====
        function showWordDetail(wordId) {
            const word = findWordById(wordId);
            if (!word) return;

            currentWordDetail = word;

            const modal = document.getElementById('word-detail-modal');
            const content = document.getElementById('word-detail-content');

            // è·å–å­¦ä¹ å†å²
            const history = WordAdventure.gameState.learning.wordHistory[wordId] || [];
            const mastery = WordAdventure.calculateMasteryLevel(wordId);

            content.innerHTML = `
                <div class="word-detail-main">
                    <div class="word-detail-word">${word.word}</div>
                    <div class="word-detail-phonetic">${word.pronunciation}</div>
                    <div class="word-detail-chinese">${word.chinese}</div>
                </div>
                
                <div class="word-detail-section">
                    <h4>è®°å¿†å£è¯€</h4>
                    <div class="word-mnemonic">${word.mnemonic}</div>
                </div>
                
                <div class="word-detail-section">
                    <h4>è”æƒ³åœºæ™¯</h4>
                    <div class="word-association">${word.è”æƒ³}</div>
                </div>
                
                <div class="word-detail-section">
                    <h4>å­¦ä¹ è¿›åº¦</h4>
                    <div class="mastery-info">
                        <div class="mastery-stars">${generateMasteryStars(mastery)}</div>
                        <div class="mastery-text">${getMasteryText(mastery)}</div>
                        <div class="learning-count">å­¦ä¹ æ¬¡æ•°: ${history.length}</div>
                    </div>
                </div>
                
                ${history.length > 0 ? `
                    <div class="word-detail-section">
                        <h4>å­¦ä¹ è®°å½•</h4>
                        <div class="history-list">
                            ${history.slice(-5).map(record => `
                                <div class="history-item">
                                    <div class="history-date">${formatDate(record.timestamp)}</div>
                                    <div class="history-score">å¾—åˆ†: ${record.score}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;

            modal.style.display = 'flex';
        }

        function closeWordDetail() {
            document.getElementById('word-detail-modal').style.display = 'none';
            currentWordDetail = null;
        }

        function generateMasteryStars(level) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<span class="mastery-star ${i <= level ? 'filled' : 'empty'}">â­</span>`;
            }
            return stars;
        }

        function getMasteryText(level) {
            const texts = ['æœªå­¦ä¹ ', 'åˆšå­¦ä¹ ', 'åˆæ­¥æŒæ¡', 'è‰¯å¥½', 'ç†Ÿç»ƒ', 'å®Œå…¨æŒæ¡'];
            return texts[level] || texts[0];
        }

        function findWordById(wordId) {
            for (const difficulty in WordAdventureData.WordDatabase) {
                const word = WordAdventureData.WordDatabase[difficulty].find(w => w.id === wordId);
                if (word) return { ...word, difficulty };
            }
            return null;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        // ===== ç»Ÿè®¡æ•°æ®æ›´æ–° =====
        function updateStatistics() {
            const gameState = WordAdventure.gameState;
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const learnedCount = gameState.learning.learnedWords.length;
            const masteredCount = gameState.learning.masteredWords.length;
            const reviewCount = gameState.learning.reviewingWords.filter(review => review.reviewDate <= Date.now()).length;
            const todayWords = getTodayLearnedCount();

            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            document.getElementById('learned-count').textContent = learnedCount;
            document.getElementById('mastered-count').textContent = masteredCount;
            document.getElementById('total-words').textContent = Object.keys(WordAdventureData.WordDatabase).reduce((sum, difficulty) => {
                return sum + WordAdventureData.WordDatabase[difficulty].length;
            }, 0);
            document.getElementById('today-words').textContent = todayWords;
            document.getElementById('review-words').textContent = reviewCount;
        }

        function getTodayLearnedCount() {
            const today = new Date().toDateString();
            const history = WordAdventure.gameState.learning.wordHistory;
            let count = 0;

            for (const wordId in history) {
                const todayRecords = history[wordId].filter(record => {
                    return new Date(record.timestamp).toDateString() === today;
                });
                
                if (todayRecords.length > 0) {
                    count++;
                }
            }

            return count;
        }

        // ===== åŠŸèƒ½æ“ä½œ =====
        function playWordAudio() {
            if (!currentWordDetail) return;
            
            // æ’­æ”¾å•è¯å‘éŸ³
            console.log(`æ’­æ”¾å‘éŸ³: ${currentWordDetail.word}`);
            WordAdventureUI.playSound('click');
            
            WordAdventureUI.showToast('æ­£åœ¨æ’­æ”¾å‘éŸ³...', 'info');
        }

        function startWordPractice() {
            if (!currentWordDetail) return;
            
            // è·³è½¬åˆ°ç»ƒä¹ é¡µé¢
            const practiceUrl = `challenge.html?word=${currentWordDetail.id}`;
            if (window.parent && window.parent.NavigationManager) {
                window.parent.NavigationManager.navigateToPage(practiceUrl);
            } else {
                window.location.href = practiceUrl;
            }
        }

        // ===== äº‹ä»¶ç›‘å¬ =====
        function setupEventListeners() {
            // ç›‘å¬æ¸¸æˆçŠ¶æ€å˜åŒ–
            WordAdventure.on('wordLearned', function() {
                loadWordList();
                updateStatistics();
            });

            WordAdventure.on('experienceGained', function() {
                updateStatistics();
            });

            // ç›‘å¬æ¨¡æ€æ¡†å¤–éƒ¨ç‚¹å‡»
            document.getElementById('word-detail-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeWordDetail();
                }
            });

            // é”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeWordDetail();
                }
            });
        }

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°æ•°æ®
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                updateStatistics();
            }
        });
    </script>

    <style>
        /* å•è¯å›¾é‰´é¡µé¢æ ·å¼ */
        .header-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
        }

        /* æœç´¢ç­›é€‰åŒºåŸŸ */
        .search-filter-section {
            background: white;
            padding: 16px;
            margin: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .search-bar input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
        }

        .search-btn {
            padding: 10px 15px;
            border: none;
            background: #6A11CB;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 8px 16px;
            border: 1px solid #e9ecef;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .filter-tab:hover {
            border-color: #6A11CB;
        }

        .filter-tab.active {
            background: #6A11CB;
            color: white;
            border-color: #6A11CB;
        }

        .difficulty-filter select {
            width: 100%;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 12px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .word-stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin: 16px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .summary-icon {
            font-size: 24px;
        }

        .summary-number {
            font-size: 20px;
            font-weight: bold;
            color: #6A11CB;
        }

        .summary-label {
            font-size: 12px;
            color: #666;
        }

        /* å•è¯åˆ—è¡¨ */
        .word-list {
            padding: 0 16px 16px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .word-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

        .word-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .word-card.new {
            border-left-color: #6c757d;
        }

        .word-card.learning {
            border-left-color: #ffc107;
        }

        .word-card.reviewing {
            border-left-color: #17a2b8;
        }

        .word-card.mastered {
            border-left-color: #28a745;
        }

        .word-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .word-main {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .word-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 500;
        }

        .word-phonetic {
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
        }

        .word-chinese {
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 12px;
        }

        .word-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .word-difficulty {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
        }

        .word-difficulty.beginner {
            background: #4CAF50;
        }

        .word-difficulty.intermediate {
            background: #FF9800;
        }

        .word-difficulty.advanced {
            background: #FF3B30;
        }

        .word-grade {
            font-size: 10px;
            color: #666;
        }

        /* å•è¯è¯¦æƒ…æ¨¡æ€æ¡† */
        .word-detail-modal {
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .word-detail-header {
            padding: 20px 20px 0 20px;
            text-align: right;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .word-detail-content {
            padding: 20px;
        }

        .word-detail-main {
            text-align: center;
            margin-bottom: 20px;
        }

        .word-detail-word {
            font-size: 32px;
            font-weight: bold;
            color: #6A11CB;
            margin-bottom: 8px;
        }

        .word-detail-phonetic {
            font-size: 14px;
            color: #666;
            margin-bottom: 6px;
        }

        .word-detail-chinese {
            font-size: 18px;
            color: #333;
        }

        .word-detail-section {
            margin-bottom: 20px;
        }

        .word-detail-section h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .word-mnemonic, .word-association {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        .mastery-info {
            text-align: center;
        }

        .mastery-stars {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .mastery-star.filled {
            color: #FFD700;
        }

        .mastery-star.empty {
            color: #e9ecef;
        }

        .mastery-text {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .learning-count {
            font-size: 12px;
            color: #666;
        }

        .history-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 12px;
        }

        .history-date {
            color: #666;
        }

        .history-score {
            font-weight: bold;
            color: #6A11CB;
        }

        .word-detail-actions {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #e9ecef;
        }

        .word-detail-actions button {
            flex: 1;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 14px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .word-list {
                grid-template-columns: 1fr;
            }
            
            .word-stats-summary {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .summary-card {
                flex-direction: column;
                gap: 5px;
            }
            
            .filter-tabs {
                justify-content: center;
            }
        }

        @media (max-width: 375px) {
            .word-card {
                padding: 12px;
            }
            
            .word-main {
                font-size: 16px;
            }
            
            .word-detail-word {
                font-size: 28px;
            }
        }
    </style>
</body>
</html>