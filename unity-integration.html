<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unityé›†æˆ - AIå°è¯´åˆ›ä½œç³»ç»Ÿ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }

        .unity-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .unity-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .unity-header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .unity-content {
            padding: 40px;
        }

        .integration-status {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: #dc3545;
            animation: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .api-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .test-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .test-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .test-card h3 {
            margin: 0 0 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            width: 100%;
        }

        .test-button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .code-section {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .code-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #4a5568;
        }

        .code-tab {
            background: none;
            border: none;
            color: #a0aec0;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .code-tab.active {
            color: #e2e8f0;
            border-bottom-color: #667eea;
        }

        .code-content {
            display: none;
        }

        .code-content.active {
            display: block;
        }

        .code-block {
            background: #1a202c;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            white-space: pre-wrap;
            margin-bottom: 15px;
        }

        .response-log {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            background: white;
        }

        .log-entry.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .log-entry.success {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .log-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .log-message {
            font-size: 14px;
            line-height: 1.4;
        }

        .connection-info {
            background: #e3f2fd;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .connection-steps {
            margin-top: 20px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-text {
            color: #333;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="unity-container">
        <header class="unity-header">
            <h1>ğŸ® Unityé›†æˆä¸­å¿ƒ</h1>
            <p>AIå°è¯´åˆ›ä½œç³»ç»Ÿ - Unity APIæ¥å£å’Œé›†æˆæŒ‡å—</p>
        </header>

        <div class="unity-content">
            <!-- è¿æ¥çŠ¶æ€ -->
            <div class="integration-status">
                <div class="status-indicator">
                    <div class="status-dot" id="connectionStatus"></div>
                    <span id="connectionText">æ£€æµ‹Unityè¿æ¥...</span>
                </div>
                <div id="connectionInfo">
                    æ­£åœ¨åˆå§‹åŒ–Unity APIæ¡¥æ¥...
                </div>
            </div>

            <!-- è¿æ¥æ­¥éª¤ -->
            <div class="connection-info">
                <h3>ğŸ”Œ Unityé›†æˆæ­¥éª¤</h3>
                <div class="connection-steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-text">åœ¨Unityä¸­æ·»åŠ WebViewç»„ä»¶ï¼ŒåŠ è½½story-creator.html</div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-text">åŒ…å«unity-api-bridge.jsæ–‡ä»¶åˆ°WebViewé¡µé¢</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-text">åœ¨C#è„šæœ¬ä¸­å®ç°JavaScriptæ¡¥æ¥æ–¹æ³•</div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-text">é€šè¿‡APIè°ƒç”¨å®ç°Unityä¸ç½‘é¡µçš„åŒå‘é€šä¿¡</div>
                    </div>
                </div>
            </div>

            <!-- APIæµ‹è¯• -->
            <div class="api-test-grid">
                <div class="test-card">
                    <h3>ğŸ“– åˆ›å»ºæ•…äº‹</h3>
                    <p class="test-description">æµ‹è¯•åˆ›å»ºæ–°æ•…äº‹åŠŸèƒ½ï¼ŒæŒ‡å®šæ ‡é¢˜ã€ç±»å‹å’Œæ¨¡æ¿</p>
                    <button class="test-button" onclick="testCreateStory()">æµ‹è¯•åˆ›å»ºæ•…äº‹</button>
                </div>

                <div class="test-card">
                    <h3>ğŸ“š è·å–æ¨¡æ¿</h3>
                    <p class="test-description">æµ‹è¯•è·å–æ•…äº‹æ¨¡æ¿åº“ï¼Œæ”¯æŒæŒ‰ç±»å‹ç­›é€‰</p>
                    <button class="test-button" onclick="testGetTemplates()">æµ‹è¯•è·å–æ¨¡æ¿</button>
                </div>

                <div class="test-card">
                    <h3>ğŸ‘¥ ç”Ÿæˆè§’è‰²</h3>
                    <p class="test-description">æµ‹è¯•æ™ºèƒ½è§’è‰²ç”Ÿæˆå™¨ï¼ŒåŸºäºåŸå‹åˆ›å»ºè§’è‰²</p>
                    <button class="test-button" onclick="testGenerateCharacter()">æµ‹è¯•ç”Ÿæˆè§’è‰²</button>
                </div>

                <div class="test-card">
                    <h3>ğŸ¤– AIååŠ©</h3>
                    <p class="test-description">æµ‹è¯•AIåŠ©æ‰‹åŠŸèƒ½ï¼Œè·å–åˆ›ä½œå»ºè®®å’Œå¸®åŠ©</p>
                    <button class="test-button" onclick="testAIAssist()">æµ‹è¯•AIååŠ©</button>
                </div>

                <div class="test-card">
                    <h3">ğŸ’¾ ä¿å­˜é¡¹ç›®</h3>
                    <p class="test-description">æµ‹è¯•é¡¹ç›®ä¿å­˜åŠŸèƒ½ï¼Œæ”¯æŒæœ¬åœ°å’Œæ–‡ä»¶å¯¼å‡º</p>
                    <button class="test-button" onclick="testSaveProject()">æµ‹è¯•ä¿å­˜é¡¹ç›®</button>
                </div>

                <div class="test-card">
                    <h3>ğŸ“‚ åŠ è½½é¡¹ç›®</h3>
                    <p class="test-description">æµ‹è¯•é¡¹ç›®åŠ è½½åŠŸèƒ½ï¼Œæ¢å¤åˆ›ä½œè¿›åº¦</p>
                    <button class="test-button" onclick="testLoadProject()">æµ‹è¯•åŠ è½½é¡¹ç›®</button>
                </div>
            </div>

            <!-- ä»£ç ç¤ºä¾‹ -->
            <div class="code-section">
                <div class="code-tabs">
                    <button class="code-tab active" onclick="switchCodeTab('csharp')">C# è„šæœ¬</button>
                    <button class="code-tab" onclick="switchCodeTab('javascript')">JavaScript</button>
                    <button class="code-tab" onclick="switchCodeTab('api')">API åˆ—è¡¨</button>
                </div>

                <div class="code-content active" id="csharp-code">
                    <h4>Unity C# è„šæœ¬ç¤ºä¾‹</h4>
                    <div class="code-block">using UnityEngine;
using UnityEngine.UI;

public class StoryCreatorBridge : MonoBehaviour
{
    public WebViewObject webView;
    
    void Start()
    {
        // åˆå§‹åŒ–WebView
        string url = Application.streamingAssetsPath + "/story-creator.html";
        webView.Init((success) => {
            if (success) {
                Debug.Log("å°è¯´åˆ›ä½œç³»ç»ŸåŠ è½½æˆåŠŸ");
            }
        });
    }
    
    public void CreateNewStory()
    {
        string jsonData = @"{
            ""title"": ""éƒ½å¸‚çˆ±æƒ…æ•…äº‹"",
            ""genre"": ""romance"",
            ""templateId"": ""modern_city_love""
        }";
        
        webView.EvaluateJS($@"
            if (window.unityBridge) {{
                window.unityBridge.handleCreateStory({jsonData});
            }}
        ");
    }
    
    // Unityå›è°ƒæ–¹æ³•
    public void OnStoryCreated(string storyData)
    {
        Debug.Log("æ•…äº‹åˆ›å»ºå›è°ƒ: " + storyData);
    }
}</div>
                </div>

                <div class="code-content" id="javascript-code">
                    <h4>JavaScript API è°ƒç”¨</h4>
                    <div class="code-block">// å‘é€æ¶ˆæ¯åˆ°Unity
function sendToUnity(methodName, data) {
    if (typeof window.Unity !== 'undefined') {
        window.Unity.call(methodName, JSON.stringify(data));
    } else if (window.unity) {
        window.unity.SendMessage('WebBridgeObject', methodName, JSON.stringify(data));
    }
}

// ç¤ºä¾‹ï¼šé€šçŸ¥Unityæ•…äº‹å·²åˆ›å»º
function notifyStoryCreated(storyData) {
    sendToUnity('OnStoryCreated', storyData);
}</div>
                </div>

                <div class="code-content" id="api-code">
                    <h4>API æ–¹æ³•åˆ—è¡¨</h4>
                    <div class="code-block">å¯ç”¨APIæ–¹æ³•ï¼š

CREATE_STORY - åˆ›å»ºæ–°æ•…äº‹
å‚æ•°: {title, genre, templateId}

GET_TEMPLATES - è·å–æ•…äº‹æ¨¡æ¿
å‚æ•°: {genre} (å¯é€‰)

GENERATE_CHARACTER - ç”Ÿæˆè§’è‰²
å‚æ•°: {archetype, name}

AI_ASSIST - AIååŠ©
å‚æ•°: {query, context}

SAVE_PROJECT - ä¿å­˜é¡¹ç›®
å‚æ•°: {projectData, fileName}

LOAD_PROJECT - åŠ è½½é¡¹ç›®
å‚æ•°: {projectId}

Unityå›è°ƒæ–¹æ³•ï¼š
OnStoryCreated(data)
OnTemplatesLoaded(data)
OnCharacterGenerated(data)
OnAIResponse(data)
OnProjectSaved(data)
OnProjectLoaded(data)
OnError(errorData)</div>
                </div>
            </div>

            <!-- å“åº”æ—¥å¿— -->
            <div class="response-log">
                <h3>ğŸ“‹ APIå“åº”æ—¥å¿—</h3>
                <div id="logContainer">
                    <div class="log-entry">
                        <div class="log-time">ç³»ç»Ÿå¯åŠ¨</div>
                        <div class="log-message">Unity APIæ¡¥æ¥å·²åˆå§‹åŒ–ï¼Œç­‰å¾…è¿æ¥...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="story-templates.js"></script>
    <script src="multi-agent-coordinator.js"></script>
    <script src="agent-planning.js"></script>
    <script src="agent-execution.js"></script>
    <script src="agent-response.js"></script>
    <script src="story-creation-agent.js"></script>
    <script src="unity-api-bridge.js"></script>

    <script>
        let unityBridge;
        let isConnected = false;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeUnityIntegration();
        });

        function initializeUnityIntegration() {
            try {
                // åˆå§‹åŒ–Unity APIæ¡¥æ¥
                unityBridge = new UnityAPIBridge();
                
                // æ£€æŸ¥è¿æ¥çŠ¶æ€
                setTimeout(() => {
                    updateConnectionStatus(unityBridge.isConnected());
                }, 1000);

                addLog('ç³»ç»Ÿåˆå§‹åŒ–', 'Unity APIæ¡¥æ¥å·²æˆåŠŸåˆå§‹åŒ–', 'success');

            } catch (error) {
                updateConnectionStatus(false);
                addLog('åˆå§‹åŒ–å¤±è´¥', error.message, 'error');
            }
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusDot = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            const connectionInfo = document.getElementById('connectionInfo');

            if (connected) {
                statusDot.classList.remove('disconnected');
                statusText.textContent = 'å·²è¿æ¥åˆ°Unity';
                connectionInfo.textContent = 'Unity APIæ¡¥æ¥å·¥ä½œæ­£å¸¸ï¼Œå¯ä»¥è¿›è¡Œé€šä¿¡';
            } else {
                statusDot.classList.add('disconnected');
                statusText.textContent = 'æœªæ£€æµ‹åˆ°Unityç¯å¢ƒ';
                connectionInfo.textContent = 'è¯·åœ¨Unity WebViewä¸­åŠ è½½æ­¤é¡µé¢ä»¥å¯ç”¨Unityé›†æˆ';
            }
        }

        function switchCodeTab(tabName) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.code-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.code-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-code').classList.add('active');
        }

        function addLog(title, message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <div class="log-time">${time} - ${title}</div>
                <div class="log-message">${message}</div>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // APIæµ‹è¯•å‡½æ•°
        async function testCreateStory() {
            addLog('æµ‹è¯•åˆ›å»ºæ•…äº‹', 'å‘é€åˆ›å»ºæ•…äº‹è¯·æ±‚...');
            
            try {
                const result = await unityBridge.handleCreateStory({
                    title: 'Unityæµ‹è¯•æ•…äº‹',
                    genre: 'romance',
                    templateId: 'modern_city_love'
                });
                
                addLog('åˆ›å»ºæ•…äº‹æˆåŠŸ', 'æ•…äº‹å·²æˆåŠŸåˆ›å»º', 'success');
            } catch (error) {
                addLog('åˆ›å»ºæ•…äº‹å¤±è´¥', error.message, 'error');
            }
        }

        async function testGetTemplates() {
            addLog('æµ‹è¯•è·å–æ¨¡æ¿', 'è·å–æ‰€æœ‰æ•…äº‹æ¨¡æ¿...');
            
            try {
                const result = await unityBridge.handleGetTemplates({});
                addLog('è·å–æ¨¡æ¿æˆåŠŸ', `å·²è·å– ${result.templates?.length || 0} ä¸ªæ¨¡æ¿`, 'success');
            } catch (error) {
                addLog('è·å–æ¨¡æ¿å¤±è´¥', error.message, 'error');
            }
        }

        async function testGenerateCharacter() {
            addLog('æµ‹è¯•ç”Ÿæˆè§’è‰²', 'ç”Ÿæˆæ–°è§’è‰²...');
            
            try {
                const result = await unityBridge.handleGenerateCharacter({
                    archetype: 'hero',
                    name: ''
                });
                
                addLog('è§’è‰²ç”ŸæˆæˆåŠŸ', `è§’è‰²åç§°: ${result.character?.name || 'æœªçŸ¥'}`, 'success');
            } catch (error) {
                addLog('è§’è‰²ç”Ÿæˆå¤±è´¥', error.message, 'error');
            }
        }

        async function testAIAssist() {
            addLog('æµ‹è¯•AIååŠ©', 'å‘é€AIååŠ©è¯·æ±‚...');
            
            try {
                const result = await unityBridge.handleAIAssist({
                    query: 'å¸®æˆ‘å†™ä¸€ä¸ªæ•…äº‹å¼€å¤´',
                    context: {}
                });
                
                addLog('AIååŠ©æˆåŠŸ', 'AIå·²è¿”å›å“åº”', 'success');
            } catch (error) {
                addLog('AIååŠ©å¤±è´¥', error.message, 'error');
            }
        }

        function testSaveProject() {
            addLog('æµ‹è¯•ä¿å­˜é¡¹ç›®', 'ä¿å­˜æµ‹è¯•é¡¹ç›®...');
            
            try {
                unityBridge.handleSaveProject({
                    projectData: {
                        title: 'Unityæµ‹è¯•é¡¹ç›®',
                        content: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é¡¹ç›®å†…å®¹'
                    },
                    fileName: 'unity-test-project.txt'
                });
                
                addLog('ä¿å­˜é¡¹ç›®æˆåŠŸ', 'é¡¹ç›®å·²ä¿å­˜', 'success');
            } catch (error) {
                addLog('ä¿å­˜é¡¹ç›®å¤±è´¥', error.message, 'error');
            }
        }

        function testLoadProject() {
            addLog('æµ‹è¯•åŠ è½½é¡¹ç›®', 'åŠ è½½æµ‹è¯•é¡¹ç›®...');
            
            try {
                unityBridge.handleLoadProject({});
                addLog('åŠ è½½é¡¹ç›®æˆåŠŸ', 'é¡¹ç›®å·²åŠ è½½', 'success');
            } catch (error) {
                addLog('åŠ è½½é¡¹ç›®å¤±è´¥', error.message, 'error');
            }
        }
    </script>
</body>
</html>