<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå°è¯´åˆ›ä½œç³»ç»Ÿ - IMAçŸ¥è¯†åº“å¢å¼ºç‰ˆ</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .ima-knowledge-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: #fff;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .ima-panel.open {
            right: 0;
        }
        
        .ima-panel-header {
            background: #07c160;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ima-panel-content {
            padding: 20px;
        }
        
        .ima-search-box {
            margin-bottom: 20px;
        }
        
        .ima-search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .ima-category-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .ima-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .ima-tab.active {
            color: #07c160;
            border-bottom-color: #07c160;
        }
        
        .ima-search-results {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .ima-result-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ima-result-item:hover {
            background: #f8f9fa;
            border-color: #07c160;
        }
        
        .ima-result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .ima-result-content {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .ima-result-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .ima-tag {
            background: #f0f0f0;
            color: #666;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }
        
        .ima-toggle-btn {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: #07c160;
            color: white;
            border: none;
            padding: 15px 10px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            z-index: 999;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 14px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .ima-toggle-btn:hover {
            background: #05a050;
            padding-right: 15px;
        }
        
        .ima-config-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .ima-config-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
        }
        
        .ima-config-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .ima-form-group {
            margin-bottom: 20px;
        }
        
        .ima-form-label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }
        
        .ima-form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .ima-form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .ima-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .ima-btn-primary {
            background: #07c160;
            color: white;
        }
        
        .ima-btn-primary:hover {
            background: #05a050;
        }
        
        .ima-btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        
        .ima-btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .ima-status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .ima-status-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .ima-status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .ima-loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .ima-loading.show {
            display: block;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #07c160;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .knowledge-suggestion {
            background: #e8f5e8;
            border-left: 4px solid #07c160;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 0 6px 6px 0;
        }
        
        .knowledge-suggestion-title {
            font-weight: bold;
            color: #07c160;
            margin-bottom: 5px;
        }
        
        .knowledge-suggestion-content {
            color: #666;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- åŸæœ‰çš„å°è¯´åˆ›ä½œç•Œé¢ -->
    <div class="container">
        <header class="header">
            <h1>ğŸ­ AIå°è¯´åˆ›ä½œç³»ç»Ÿ - IMAçŸ¥è¯†åº“å¢å¼ºç‰ˆ</h1>
            <div class="header-actions">
                <button class="btn-secondary" onclick="openIMAConfig()">IMAçŸ¥è¯†åº“é…ç½®</button>
                <button class="btn-primary" onclick="saveProject()">ğŸ’¾ ä¿å­˜é¡¹ç›®</button>
            </div>
        </header>

        <main class="main-content">
            <!-- å·¦ä¾§åˆ›ä½œåŒºåŸŸ -->
            <section class="creation-panel">
                <div class="panel-header">
                    <h2>ğŸ“ åˆ›ä½œå·¥ä½œå°</h2>
                </div>
                
                <div class="creation-form">
                    <div class="form-group">
                        <label for="storyTitle">å°è¯´æ ‡é¢˜</label>
                        <input type="text" id="storyTitle" placeholder="è¾“å…¥æ‚¨çš„å°è¯´æ ‡é¢˜..." class="form-input">
                    </div>

                    <div class="form-group">
                        <label for="genre">æ•…äº‹ç±»å‹</label>
                        <select id="genre" class="form-select">
                            <option value="fantasy">å¥‡å¹»å†’é™©</option>
                            <option value="romance">æµªæ¼«çˆ±æƒ…</option>
                            <option value="mystery">æ‚¬ç–‘æ¨ç†</option>
                            <option value="scifi">ç§‘å¹»æœªæ¥</option>
                            <option value="historical">å†å²ä¼ å¥‡</option>
                            <option value="modern">éƒ½å¸‚ç°å®</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="storyOutline">æ•…äº‹å¤§çº²</label>
                        <textarea id="storyOutline" rows="4" placeholder="æè¿°æ‚¨çš„æ•…äº‹æ„æ€..." class="form-textarea"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="mainCharacters">ä¸»è¦è§’è‰²</label>
                        <textarea id="mainCharacters" rows="3" placeholder="æè¿°ä¸»è¦è§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯..." class="form-textarea"></textarea>
                    </div>

                    <button class="btn-primary btn-large" onclick="startCreation()">
                        ğŸš€ å¼€å§‹AIè¾…åŠ©åˆ›ä½œ
                    </button>
                </div>

                <div id="creationResult" class="result-panel" style="display: none;">
                    <div class="panel-header">
                        <h3>âœ¨ AIåˆ›ä½œæˆæœ</h3>
                    </div>
                    <div id="generatedContent" class="generated-content"></div>
                </div>
            </section>

            <!-- å³ä¾§å·¥å…·åŒºåŸŸ -->
            <aside class="tools-panel">
                <div class="panel-header">
                    <h3>ğŸ› ï¸ åˆ›ä½œå·¥å…·ç®±</h3>
                </div>
                
                <div class="tools-grid">
                    <button class="tool-btn" onclick="openAdvancedTools()">
                        ğŸ§  AIé«˜çº§å·¥å…·
                    </button>
                    <button class="tool-btn" onclick="openPlotTool()">
                        ğŸ“Š æƒ…èŠ‚å¤§çº²å·¥å…·
                    </button>
                    <button class="tool-btn" onclick="showMemoryStats()">
                        ğŸ’­ è®°å¿†ç»Ÿè®¡
                    </button>
                    <button class="tool-btn" onclick="toggleIMAPanel()">
                        ğŸ“š IMAçŸ¥è¯†åº“
                    </button>
                </div>

                <div id="memoryStats" class="memory-stats" style="display: none;">
                    <h4>ğŸ“Š è®°å¿†ç»Ÿè®¡</h4>
                    <div id="statsContent"></div>
                </div>
            </aside>
        </main>
    </div>

    <!-- IMAçŸ¥è¯†åº“é¢æ¿ -->
    <div class="ima-panel" id="imaPanel">
        <div class="ima-panel-header">
            <h3>ğŸ“š IMAçŸ¥è¯†åº“</h3>
            <button onclick="toggleIMAPanel()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">Ã—</button>
        </div>
        
        <div class="ima-panel-content">
            <div id="imaStatus" class="ima-status-indicator ima-status-disconnected">
                <span class="status-dot">â—</span>
                <span class="status-text">æœªè¿æ¥</span>
            </div>

            <div class="ima-search-box">
                <input type="text" id="imaSearchInput" placeholder="æœç´¢å¾®ä¿¡å¼€å‘çŸ¥è¯†..." class="ima-search-input" onkeyup="handleIMASearch(event)">
            </div>

            <div class="ima-category-tabs">
                <div class="ima-tab active" onclick="switchIMACategory('all')">å…¨éƒ¨</div>
                <div class="ima-tab" onclick="switchIMACategory('api')">API</div>
                <div class="ima-tab" onclick="switchIMACategory('component')">ç»„ä»¶</div>
                <div class="ima-tab" onclick="switchIMACategory('tutorial')">æ•™ç¨‹</div>
                <div class="ima-tab" onclick="switchIMACategory('practice')">å®è·µ</div>
            </div>

            <div class="ima-loading" id="imaLoading">
                <div class="spinner"></div>
                æ­£åœ¨æœç´¢...
            </div>

            <div class="ima-search-results" id="imaSearchResults">
                <!-- æœç´¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
    </div>

    <!-- IMAçŸ¥è¯†åº“åˆ‡æ¢æŒ‰é’® -->
    <button class="ima-toggle-btn" onclick="toggleIMAPanel()">
        IMAçŸ¥è¯†åº“
    </button>

    <!-- IMAé…ç½®æ¨¡æ€æ¡† -->
    <div class="ima-config-modal" id="imaConfigModal">
        <div class="ima-config-content">
            <h3 class="ima-config-title">é…ç½®IMAçŸ¥è¯†åº“è¿æ¥</h3>
            
            <div class="ima-form-group">
                <label class="ima-form-label">å¾®ä¿¡å°ç¨‹åºAppID</label>
                <input type="text" id="wxAppId" placeholder="è¯·è¾“å…¥å¾®ä¿¡å°ç¨‹åºAppID" class="ima-form-input">
            </div>

            <div class="ima-form-group">
                <label class="ima-form-label">å¾®ä¿¡å°ç¨‹åºAppSecret</label>
                <input type="password" id="wxAppSecret" placeholder="è¯·è¾“å…¥å¾®ä¿¡å°ç¨‹åºAppSecret" class="ima-form-input">
            </div>

            <div class="ima-form-group">
                <label class="ima-form-label">IMAçŸ¥è¯†åº“APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="imaApiKey" placeholder="è¯·è¾“å…¥IMA APIå¯†é’¥" class="ima-form-input">
            </div>

            <div class="ima-form-buttons">
                <button class="ima-btn ima-btn-secondary" onclick="closeIMAConfig()">å–æ¶ˆ</button>
                <button class="ima-btn ima-btn-primary" onclick="saveIMAConfig()">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="js/story-creation-agent.js"></script>
    <script src="js/story-templates.js"></script>
    <script src="memory-manager.js"></script>
    <script src="weixin-ima-knowledge-base.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let storyAgent;
        let memoryManager;
        let imaKnowledgeBase;
        let currentCategory = 'all';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ¬ åˆå§‹åŒ–AIå°è¯´åˆ›ä½œç³»ç»Ÿ...');
            
            try {
                // åˆå§‹åŒ–æ•…äº‹åˆ›ä½œä»£ç†
                storyAgent = new StoryCreationAgent();
                
                // åˆå§‹åŒ–è®°å¿†ç®¡ç†å™¨
                memoryManager = new MemoryManager();
                
                // åˆå§‹åŒ–IMAçŸ¥è¯†åº“
                imaKnowledgeBase = new WeixinIMAKnowledgeBase();
                await initializeIMAConnection();
                
                console.log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                showError('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        });

        // åˆå§‹åŒ–IMAè¿æ¥
        async function initializeIMAConnection() {
            try {
                // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½é…ç½®
                const savedConfig = {
                    appId: localStorage.getItem('wx_app_id'),
                    appSecret: localStorage.getItem('wx_app_secret'),
                    imaApiKey: localStorage.getItem('ima_api_key')
                };

                if (savedConfig.appId && savedConfig.appSecret) {
                    const success = await imaKnowledgeBase.initialize(savedConfig);
                    updateIMAStatus(success);
                }
            } catch (error) {
                console.error('IMAåˆå§‹åŒ–å¤±è´¥:', error);
                updateIMAStatus(false);
            }
        }

        // æ›´æ–°IMAçŠ¶æ€æŒ‡ç¤ºå™¨
        function updateIMAStatus(isConnected) {
            const statusEl = document.getElementById('imaStatus');
            const statusDot = statusEl.querySelector('.status-dot');
            const statusText = statusEl.querySelector('.status-text');

            if (isConnected) {
                statusEl.className = 'ima-status-indicator ima-status-connected';
                statusText.textContent = 'å·²è¿æ¥';
            } else {
                statusEl.className = 'ima-status-indicator ima-status-disconnected';
                statusText.textContent = 'æœªè¿æ¥';
            }
        }

        // åˆ‡æ¢IMAé¢æ¿
        function toggleIMAPanel() {
            const panel = document.getElementById('imaPanel');
            panel.classList.toggle('open');
        }

        // æ‰“å¼€IMAé…ç½®
        function openIMAConfig() {
            document.getElementById('imaConfigModal').style.display = 'flex';
            
            // åŠ è½½å·²ä¿å­˜çš„é…ç½®
            document.getElementById('wxAppId').value = localStorage.getItem('wx_app_id') || '';
            document.getElementById('wxAppSecret').value = localStorage.getItem('wx_app_secret') || '';
            document.getElementById('imaApiKey').value = localStorage.getItem('ima_api_key') || '';
        }

        // å…³é—­IMAé…ç½®
        function closeIMAConfig() {
            document.getElementById('imaConfigModal').style.display = 'none';
        }

        // ä¿å­˜IMAé…ç½®
        async function saveIMAConfig() {
            const appId = document.getElementById('wxAppId').value.trim();
            const appSecret = document.getElementById('wxAppSecret').value.trim();
            const imaApiKey = document.getElementById('imaApiKey').value.trim();

            if (!appId || !appSecret) {
                showError('è¯·å¡«å†™å¾®ä¿¡å°ç¨‹åºçš„AppIDå’ŒAppSecret');
                return;
            }

            try {
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('wx_app_id', appId);
                localStorage.setItem('wx_app_secret', appSecret);
                localStorage.setItem('ima_api_key', imaApiKey);

                // é‡æ–°åˆå§‹åŒ–IMAè¿æ¥
                const success = await imaKnowledgeBase.initialize({ appId, appSecret, imaApiKey });
                updateIMAStatus(success);

                if (success) {
                    showSuccess('IMAçŸ¥è¯†åº“é…ç½®æˆåŠŸï¼');
                    closeIMAConfig();
                } else {
                    showError('IMAçŸ¥è¯†åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ä¿¡æ¯');
                }
            } catch (error) {
                console.error('ä¿å­˜IMAé…ç½®å¤±è´¥:', error);
                showError('ä¿å­˜é…ç½®å¤±è´¥ï¼š' + error.message);
            }
        }

        // å¤„ç†IMAæœç´¢
        async function handleIMASearch(event) {
            if (event.key === 'Enter') {
                const query = event.target.value.trim();
                if (query) {
                    await searchIMA(query);
                }
            }
        }

        // æœç´¢IMAçŸ¥è¯†åº“
        async function searchIMA(query) {
            const loadingEl = document.getElementById('imaLoading');
            const resultsEl = document.getElementById('imaSearchResults');
            
            loadingEl.classList.add('show');
            resultsEl.innerHTML = '';

            try {
                const results = await imaKnowledgeBase.search(query, {
                    category: currentCategory,
                    limit: 10
                });

                displayIMAResults(results);
            } catch (error) {
                console.error('IMAæœç´¢å¤±è´¥:', error);
                resultsEl.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
            } finally {
                loadingEl.classList.remove('show');
            }
        }

        // æ˜¾ç¤ºIMAæœç´¢ç»“æœ
        function displayIMAResults(results) {
            const resultsEl = document.getElementById('imaSearchResults');
            
            if (results.length === 0) {
                resultsEl.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</div>';
                return;
            }

            resultsEl.innerHTML = results.map(item => `
                <div class="ima-result-item" onclick="applyIMAKnowledge('${item.id}', '${encodeURIComponent(item.title)}', '${encodeURIComponent(item.content)}')">
                    <div class="ima-result-title">${item.title}</div>
                    <div class="ima-result-content">${item.content}</div>
                    <div class="ima-result-tags">
                        ${item.tags.map(tag => `<span class="ima-tag">${tag}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // åˆ‡æ¢IMAåˆ†ç±»
        function switchIMACategory(category) {
            currentCategory = category;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.ima-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // é‡æ–°æœç´¢
            const searchInput = document.getElementById('imaSearchInput');
            if (searchInput.value.trim()) {
                searchIMA(searchInput.value.trim());
            }
        }

        // åº”ç”¨IMAçŸ¥è¯†åˆ°åˆ›ä½œ
        function applyIMAKnowledge(knowledgeId, title, content) {
            const decodedTitle = decodeURIComponent(title);
            const decodedContent = decodeURIComponent(content);
            
            // åœ¨åˆ›ä½œåŒºåŸŸæ˜¾ç¤ºçŸ¥è¯†å»ºè®®
            const suggestionHtml = `
                <div class="knowledge-suggestion">
                    <div class="knowledge-suggestion-title">ğŸ’¡ æ¥è‡ªIMAçŸ¥è¯†åº“çš„å»ºè®®ï¼š${decodedTitle}</div>
                    <div class="knowledge-suggestion-content">${decodedContent}</div>
                </div>
            `;
            
            const creationResult = document.getElementById('creationResult');
            const generatedContent = document.getElementById('generatedContent');
            
            if (creationResult.style.display === 'none') {
                creationResult.style.display = 'block';
            }
            
            generatedContent.innerHTML = suggestionHtml + (generatedContent.innerHTML || '');
            
            // å…³é—­IMAé¢æ¿
            toggleIMAPanel();
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            creationResult.scrollIntoView({ behavior: 'smooth' });
        }

        // å¼€å§‹åˆ›ä½œï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
        async function startCreation() {
            const title = document.getElementById('storyTitle').value.trim();
            const genre = document.getElementById('genre').value;
            const outline = document.getElementById('storyOutline').value.trim();
            const characters = document.getElementById('mainCharacters').value.trim();

            if (!title || !outline) {
                showError('è¯·å¡«å†™å°è¯´æ ‡é¢˜å’Œæ•…äº‹å¤§çº²');
                return;
            }

            try {
                showLoading('æ­£åœ¨åˆ›ä½œä¸­...');

                const storyRequest = {
                    title: title,
                    genre: genre,
                    outline: outline,
                    characters: characters,
                    style: 'detailed'
                };

                const response = await storyAgent.createStory(storyRequest);
                
                displayStory(response);
                
                // ä¿å­˜åˆ°è®°å¿†
                if (memoryManager) {
                    await memoryManager.saveCreativeMemory('story', response);
                }

            } catch (error) {
                console.error('åˆ›ä½œå¤±è´¥:', error);
                showError('åˆ›ä½œå¤±è´¥ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºæ•…äº‹å†…å®¹
        function displayStory(story) {
            const creationResult = document.getElementById('creationResult');
            const generatedContent = document.getElementById('generatedContent');
            
            creationResult.style.display = 'block';
            
            generatedContent.innerHTML = `
                <h3>${story.title}</h3>
                <div class="story-meta">
                    <span class="genre-tag">${story.genre}</span>
                    <span class="word-count">å­—æ•°: ${story.wordCount}</span>
                </div>
                <div class="story-content">${story.content}</div>
                <div class="story-actions">
                    <button class="btn-secondary" onclick="regenerateStory()">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                    <button class="btn-primary" onclick="saveStory()">ğŸ’¾ ä¿å­˜æ•…äº‹</button>
                </div>
            `;
        }

        // è¾…åŠ©å‡½æ•°
        function showLoading(message) {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'globalLoading';
            loadingDiv.className = 'loading-overlay';
            loadingDiv.innerHTML = `<div class="loading-spinner">${message}</div>`;
            document.body.appendChild(loadingDiv);
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('globalLoading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function showError(message) {
            alert('é”™è¯¯: ' + message);
        }

        function showSuccess(message) {
            alert('æˆåŠŸ: ' + message);
        }

        // å…¶ä»–åŸæœ‰åŠŸèƒ½ä¿æŒä¸å˜
        function openAdvancedTools() {
            // å®ç°é«˜çº§å·¥å…·åŠŸèƒ½
            console.log('æ‰“å¼€é«˜çº§å·¥å…·');
        }

        function openPlotTool() {
            window.open('plot-outline-tool.html', '_blank');
        }

        function showMemoryStats() {
            if (!memoryManager) {
                showError('è®°å¿†ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                return;
            }

            const stats = memoryManager.getMemoryStats();
            const statsContent = document.getElementById('statsContent');
            
            statsContent.innerHTML = `
                <p>å¯¹è¯æ•°é‡: ${stats.conversations}</p>
                <p>æ•…äº‹æ•°é‡: ${stats.stories}</p>
                <p>è§’è‰²æ•°é‡: ${stats.characters}</p>
                <p>IMAè¿æ¥çŠ¶æ€: ${imaKnowledgeBase ? 'å·²é…ç½®' : 'æœªé…ç½®'}</p>
            `;

            document.getElementById('memoryStats').style.display = 'block';
        }

        function saveProject() {
            const projectData = {
                title: document.getElementById('storyTitle').value,
                genre: document.getElementById('genre').value,
                outline: document.getElementById('storyOutline').value,
                characters: document.getElementById('mainCharacters').value,
                savedAt: new Date().toISOString()
            };

            localStorage.setItem('currentProject', JSON.stringify(projectData));
            showSuccess('é¡¹ç›®å·²ä¿å­˜åˆ°æœ¬åœ°');
        }

        function regenerateStory() {
            startCreation();
        }

        function saveStory() {
            const storyContent = document.getElementById('generatedContent').innerText;
            localStorage.setItem('savedStory', storyContent);
            showSuccess('æ•…äº‹å·²ä¿å­˜åˆ°æœ¬åœ°');
        }
    </script>
</body>
</html>