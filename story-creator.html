<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå°è¯´åˆ›ä½œåŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .story-creator {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .creator-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }

        .creator-header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .creator-header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .creator-workspace {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            margin-bottom: 30px;
        }

        .sidebar {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar h3 {
            margin: 0 0 15px;
            color: #333;
            font-size: 1.2em;
        }

        .main-editor {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .editor-tabs {
            display: flex;
            background: #f1f3f4;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #333;
            font-weight: 500;
            border-bottom: 2px solid #667eea;
        }

        .tab:hover {
            background: rgba(255,255,255,0.5);
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .genre-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .genre-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .genre-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .genre-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .genre-card .icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .character-list {
            margin-top: 20px;
        }

        .character-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .character-item h4 {
            margin: 0 0 10px;
            color: #333;
        }

        .character-traits {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .trait-tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
        }

        .plot-timeline {
            position: relative;
            padding-left: 30px;
            margin: 20px 0;
        }

        .plot-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e0e0e0;
        }

        .plot-point {
            position: relative;
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .plot-point::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
        }

        .writing-area {
            position: relative;
        }

        .writing-textarea {
            width: 100%;
            min-height: 400px;
            padding: 20px;
            border: none;
            font-size: 16px;
            line-height: 1.8;
            resize: vertical;
        }

        .writing-tools {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .tool-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .tool-btn:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .word-count {
            margin-left: auto;
            color: #666;
            font-size: 14px;
        }

        .ai-suggestions {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-top: 20px;
            border-radius: 0 8px 8px 0;
        }

        .suggestion-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .suggestion-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .suggestion-item h4 {
            margin: 0 0 8px;
            color: #333;
        }

        .suggestion-item p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e0e0e0;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .chat-interface {
            margin-top: 20px;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 15px;
        }

        .message.user {
            text-align: right;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .message.ai .message-content {
            background: white;
            border: 1px solid #e0e0e0;
        }

        .message-content {
            display: inline-block;
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .send-btn:hover {
            background: #5a67d8;
        }

        @media (max-width: 768px) {
            .creator-workspace {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
            }

            .genre-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å¢å¼ºæ ·å¼ */
        .enhancement-badge {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .ai-suggestion {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            border-left: 4px solid #667eea;
            border-radius: 0 8px 8px 0;
            padding: 15px 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-suggestion:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .smart-toolbar {
            background: #f8f9ff;
            border-bottom: 1px solid #e3e8ff;
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .smart-btn {
            background: white;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .smart-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .writing-stats {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        /* æ¨¡æ¿åº“æ ·å¼ */
        .template-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .template-controls .form-group {
            flex: 1;
            min-width: 200px;
        }

        .template-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .template-category {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .template-category:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .template-category.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .template-category h4 {
            margin: 0 0 10px;
            color: #333;
        }

        .template-category p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .template-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .template-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .template-card h4 {
            margin: 0 0 10px;
            color: #333;
        }

        .template-card p {
            margin: 0 0 15px;
            color: #666;
            font-size: 14px;
        }

        .template-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .template-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .template-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .template-structure,
        .template-elements {
            margin-bottom: 20px;
        }

        .structure-phase,
        .element-group {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .structure-phase h6,
        .element-group h6 {
            margin: 0 0 10px;
            color: #667eea;
        }

        .materials-section {
            margin-top: 40px;
        }

        .materials-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .material-tab {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .material-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .materials-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .material-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .material-item:hover {
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .material-item h5 {
            margin: 0 0 10px;
            color: #333;
            font-size: 16px;
        }

        .material-item p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .character-generator {
            background: #f0f7ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .character-preview {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .character-preview h5 {
            margin: 0 0 15px;
            color: #333;
        }

        .character-attribute {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .character-attribute span:first-child {
            font-weight: 500;
            color: #666;
        }

        .character-attribute span:last-child {
            color: #333;
        }

        .generate-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .generate-btn:hover {
            background: #5a67d8;
        }
    </style>
</head>
<body>
    <div class="story-creator">
        <header class="creator-header">
            <h1>ğŸ“š AIå°è¯´åˆ›ä½œåŠ©æ‰‹</h1>
            <p>è®©AIæˆä¸ºä½ çš„åˆ›ä½œä¼™ä¼´ï¼Œä¸€èµ·åˆ›é€ ç²¾å½©çš„æ•…äº‹ä¸–ç•Œ</p>
        </header>

        <div class="creator-workspace">
            <!-- å·¦ä¾§è¾¹æ  -->
            <aside class="sidebar">
                <h3>ğŸ“– æ•…äº‹è®¾å®š</h3>
                <div class="form-group">
                    <label>æ•…äº‹æ ‡é¢˜</label>
                    <input type="text" id="storyTitle" placeholder="ç»™ä½ çš„æ•…äº‹èµ·ä¸ªåå­—">
                </div>

                <div class="form-group">
                    <label>æ•…äº‹ç±»å‹</label>
                    <div class="genre-grid" id="genreGrid">
                        <div class="genre-card" data-genre="romance">
                            <div class="icon">ğŸ’•</div>
                            <div>è¨€æƒ…</div>
                        </div>
                        <div class="genre-card" data-genre="fantasy">
                            <div class="icon">âš”ï¸</div>
                            <div>å¥‡å¹»</div>
                        </div>
                        <div class="genre-card" data-genre="mystery">
                            <div class="icon">ğŸ”</div>
                            <div>æ‚¬ç–‘</div>
                        </div>
                        <div class="genre-card" data-genre="historical">
                            <div class="icon">ğŸ›ï¸</div>
                            <div>å†å²</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ç›®æ ‡å­—æ•°</label>
                    <input type="number" id="targetWords" value="50000" min="1000">
                </div>

                <div class="form-group">
                    <label>åˆ›ä½œæ¨¡å¼</label>
                    <select id="creationMode">
                        <option value="interactive">äº¤äº’å¼åˆ›ä½œ</option>
                        <option value="guided">å¼•å¯¼å¼åˆ›ä½œ</option>
                        <option value="automatic">è‡ªåŠ¨ç”Ÿæˆ</option>
                        <option value="collaborative">åä½œåˆ›ä½œ</option>
                    </select>
                </div>
            </aside>

            <!-- ä¸»ç¼–è¾‘åŒº -->
            <main class="main-editor">
                <div class="editor-tabs">
                    <button class="tab active" data-tab="outline">æ•…äº‹å¤§çº²</button>
                    <button class="tab" data-tab="characters">è§’è‰²è®¾å®š</button>
                    <button class="tab" data-tab="plot">æƒ…èŠ‚å‘å±•</button>
                    <button class="tab" data-tab="writing">æ­£æ–‡å†™ä½œ</button>
                    <button class="tab" data-tab="ai-assistant">AIåŠ©æ‰‹</button>
                    <button class="tab" data-tab="templates">æ•…äº‹æ¨¡æ¿</button>
                </div>

                <!-- æ•…äº‹å¤§çº²æ ‡ç­¾é¡µ -->
                <div class="tab-content active" id="outline-tab">
                    <h3>ğŸ¯ æ•…äº‹å¤§çº²</h3>
                    <div class="form-group">
                        <label>æ•…äº‹ç®€ä»‹</label>
                        <textarea id="storySummary" placeholder="ç®€è¦æè¿°ä½ çš„æ•…äº‹å†…å®¹..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>ä¸»é¢˜æ€æƒ³</label>
                        <input type="text" id="storyTheme" placeholder="æ•…äº‹è¦è¡¨è¾¾çš„æ ¸å¿ƒä¸»é¢˜">
                    </div>

                    <div class="form-group">
                        <label>æ•…äº‹èƒŒæ™¯</label>
                        <textarea id="storySetting" placeholder="æ•…äº‹å‘ç”Ÿçš„æ—¶é—´ã€åœ°ç‚¹ã€ç¯å¢ƒ..."></textarea>
                    </div>

                    <div class="ai-suggestions" id="outlineSuggestions">
                        <h4>ğŸ’¡ AIå»ºè®®</h4>
                        <div id="outlineSuggestionList"></div>
                    </div>
                </div>

                <!-- è§’è‰²è®¾å®šæ ‡ç­¾é¡µ -->
                <div class="tab-content" id="characters-tab">
                    <h3>ğŸ‘¥ è§’è‰²è®¾å®š</h3>
                    <button class="btn-primary" onclick="addCharacter()">+ æ·»åŠ è§’è‰²</button>
                    <div class="character-list" id="characterList"></div>

                    <div class="ai-suggestions">
                        <h4>ğŸ’¡ AIè§’è‰²å»ºè®®</h4>
                        <div id="characterSuggestions"></div>
                    </div>
                </div>

                <!-- æƒ…èŠ‚å‘å±•æ ‡ç­¾é¡µ -->
                <div class="tab-content" id="plot-tab">
                    <h3>ğŸ“ˆ æƒ…èŠ‚å‘å±•</h3>
                    <div class="form-group">
                        <label>æƒ…èŠ‚ç»“æ„</label>
                        <select id="plotStructure">
                            <option value="threeAct">ä¸‰å¹•å¼ç»“æ„</option>
                            <option value="heroJourney">è‹±é›„ä¹‹æ—…</option>
                            <option value="freytag">å¼—é›·å¡”æ ¼é‡‘å­—å¡”</option>
                        </select>
                    </div>

                    <div class="plot-timeline" id="plotTimeline"></div>

                    <div class="ai-suggestions">
                        <h4>ğŸ’¡ AIæƒ…èŠ‚å»ºè®®</h4>
                        <div id="plotSuggestions"></div>
                    </div>
                </div>

                <!-- æ­£æ–‡å†™ä½œæ ‡ç­¾é¡µ -->
                <div class="tab-content" id="writing-tab">
                    <div class="writing-tools">
                        <button class="tool-btn" onclick="formatText('bold')">ç²—ä½“</button>
                        <button class="tool-btn" onclick="formatText('italic')">æ–œä½“</button>
                        <button class="tool-btn" onclick="insertChapter()">æ’å…¥ç« èŠ‚</button>
                        <button class="tool-btn" onclick="aiContinue()">AIç»­å†™</button>
                        <button class="tool-btn" onclick="showAdvancedTools()">ğŸ¤– é«˜çº§å·¥å…·</button>
                        <span class="word-count">å­—æ•°ï¼š<span id="wordCount">0</span></span>
                    </div>

                    <div class="writing-area">
                        <textarea class="writing-textarea" id="writingArea" placeholder="å¼€å§‹åˆ›ä½œä½ çš„æ•…äº‹..."></textarea>
                    </div>
                </div>

                <!-- AIåŠ©æ‰‹æ ‡ç­¾é¡µ -->
                <div class="tab-content" id="ai-assistant-tab">
                    <h3>ğŸ¤– AIåˆ›ä½œåŠ©æ‰‹</h3>
                    <div class="chat-interface">
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="chat-input-area">
                            <input type="text" class="chat-input" id="chatInput" placeholder="å‘AIåŠ©æ‰‹æé—®...">
                            <button class="send-btn" onclick="sendMessage()">â¤</button>
                        </div>
                    </div>
                </div>

                <!-- æ•…äº‹æ¨¡æ¿æ ‡ç­¾é¡µ -->
                <div class="tab-content" id="templates-tab">
                    <h3>ğŸ“š æ•…äº‹æ¨¡æ¿åº“</h3>
                    
                    <div class="template-controls">
                        <div class="form-group">
                            <label>æœç´¢æ¨¡æ¿</label>
                            <input type="text" id="templateSearch" placeholder="æœç´¢æ•…äº‹æ¨¡æ¿..." onkeyup="searchTemplates()">
                        </div>
                        <div class="form-group">
                            <label>æ•…äº‹ç±»å‹</label>
                            <select id="templateGenreFilter" onchange="filterTemplates()">
                                <option value="">å…¨éƒ¨ç±»å‹</option>
                                <option value="romance">è¨€æƒ…å°è¯´</option>
                                <option value="fantasy">å¥‡å¹»å°è¯´</option>
                                <option value="mystery">æ‚¬ç–‘æ¨ç†</option>
                                <option value="historical">å†å²å°è¯´</option>
                            </select>
                        </div>
                    </div>

                    <div class="template-categories" id="templateCategories">
                        <!-- åŠ¨æ€ç”Ÿæˆæ¨¡æ¿åˆ†ç±» -->
                    </div>

                    <div class="template-list" id="templateList">
                        <!-- åŠ¨æ€ç”Ÿæˆæ¨¡æ¿åˆ—è¡¨ -->
                    </div>

                    <div class="template-details" id="templateDetails" style="display: none;">
                        <h4 id="templateTitle"></h4>
                        <p id="templateDescription"></p>
                        <div class="template-structure">
                            <h5>æ•…äº‹ç»“æ„</h5>
                            <div id="templateStructure"></div>
                        </div>
                        <div class="template-elements">
                            <h5>æ•…äº‹å…ƒç´ </h5>
                            <div id="templateElements"></div>
                        </div>
                        <button class="btn-primary" onclick="useTemplate()">ä½¿ç”¨æ­¤æ¨¡æ¿</button>
                    </div>

                    <div class="materials-section">
                        <h4>ğŸ¨ åˆ›ä½œç´ æåº“</h4>
                        <div class="materials-tabs">
                            <button class="material-tab active" onclick="showMaterialTab('characters')">è§’è‰²ç´ æ</button>
                            <button class="material-tab" onclick="showMaterialTab('settings')">åœºæ™¯ç´ æ</button>
                            <button class="material-tab" onclick="showMaterialTab('inspirations')">çµæ„Ÿç´ æ</button>
                        </div>
                        <div class="materials-content" id="materialsContent">
                            <!-- åŠ¨æ€ç”Ÿæˆç´ æå†…å®¹ -->
                        </div>
                    </div>
                </div>
            </main>

            <!-- å³ä¾§è¾¹æ  -->
            <aside class="sidebar">
                <h3>ğŸ“Š åˆ›ä½œè¿›åº¦</h3>
                <div class="progress-info">
                    <p>å½“å‰ç« èŠ‚ï¼š<span id="currentChapter">1</span></p>
                    <p>å·²å®Œæˆå­—æ•°ï¼š<span id="completedWords">0</span></p>
                    <p>å®Œæˆè¿›åº¦ï¼š<span id="progressPercentage">0%</span></p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; margin-top: 10px;">
                        <div id="progressBar" style="background: #667eea; height: 100%; width: 0%; border-radius: 5px; transition: width 0.3s;"></div>
                    </div>
                </div>

                <div class="writing-stats">
                    <h4 style="margin-top: 20px; color: #667eea;">ğŸ“ˆ æ™ºèƒ½åˆ†æ</h4>
                    <div class="stat-item">
                        <span>é˜…è¯»éš¾åº¦</span>
                        <span id="readabilityLevel">ä¸­ç­‰</span>
                    </div>
                    <div class="stat-item">
                        <span>æƒ…æ„Ÿå€¾å‘</span>
                        <span id="emotionTone">ä¸­æ€§</span>
                    </div>
                    <div class="stat-item">
                        <span>å¹³å‡å¥é•¿</span>
                        <span id="avgSentenceLength">15</span>
                    </div>
                    <div class="stat-item">
                        <span>AIè¯„åˆ†</span>
                        <span id="aiScore">â­â­â­</span>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">ğŸ’¾ å¿«é€Ÿæ“ä½œ</h3>
                <button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="saveProject()">ä¿å­˜é¡¹ç›®</button>
                <button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="loadProject()">åŠ è½½é¡¹ç›®</button>
                <button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="exportStory()">å¯¼å‡ºæ–‡æ¡£</button>
                <button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="shareProject()">åˆ†äº«åä½œ</button>
                <button class="btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="showContextInfo()">æŸ¥çœ‹è®°å¿†</button>
                <button class="btn-secondary" style="width: 100%;" onclick="searchContext()">æœç´¢è®°å¿†</button>

                <h3 style="margin-top: 30px;">ğŸ¯ å†™ä½œç›®æ ‡</h3>
                <div class="writing-goals">
                    <p>ä»Šæ—¥ç›®æ ‡ï¼š<span id="dailyTarget">1000</span> å­—</p>
                    <p>ä»Šæ—¥å®Œæˆï¼š<span id="dailyCompleted">0</span> å­—</p>
                    <p>è¿ç»­å†™ä½œï¼š<span id="writingStreak">1</span> å¤©</p>
                </div>
            </aside>
        </div>

        <div class="action-buttons">
            <button class="btn-primary" onclick="startCreation()">å¼€å§‹åˆ›ä½œ</button>
            <button class="btn-secondary" onclick="previewStory()">é¢„è§ˆæ•…äº‹</button>
        </div>

        <!-- é«˜çº§AIå·¥å…·æ¨¡æ€æ¡† -->
        <div id="advancedToolsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-top: 0; color: #333;">ğŸ¤– AIå†™ä½œåŠ©æ‰‹å·¥å…·ç®±</h3>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #667eea;">ğŸ¨ é£æ ¼è°ƒæ•´</h4>
                    <button class="tool-btn" onclick="adjustStyle('romantic')" style="margin: 5px;">æµªæ¼«é£æ ¼</button>
                    <button class="tool-btn" onclick="adjustStyle('suspenseful')" style="margin: 5px;">æ‚¬ç–‘é£æ ¼</button>
                    <button class="tool-btn" onclick="adjustStyle('humorous')" style="margin: 5px;">å¹½é»˜é£æ ¼</button>
                    <button class="tool-btn" onclick="adjustStyle('formal')" style="margin: 5px;">æ­£å¼é£æ ¼</button>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #667eea;">âœ¨ å†…å®¹å¢å¼º</h4>
                    <button class="tool-btn" onclick="enhanceContent('descriptions')" style="margin: 5px;">ä¸°å¯Œæå†™</button>
                    <button class="tool-btn" onclick="enhanceContent('dialogues')" style="margin: 5px;">ä¼˜åŒ–å¯¹è¯</button>
                    <button class="tool-btn" onclick="enhanceContent('emotions')" style="margin: 5px;">æ·±åŒ–æƒ…æ„Ÿ</button>
                    <button class="tool-btn" onclick="enhanceContent('pacing')" style="margin: 5px;">è°ƒæ•´èŠ‚å¥</button>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #667eea;">ğŸ“ æƒ…èŠ‚ç”Ÿæˆ</h4>
                    <button class="tool-btn" onclick="generatePlotTwist()" style="margin: 5px;">æƒ…èŠ‚è½¬æŠ˜</button>
                    <button class="tool-btn" onclick="generateConflict()" style="margin: 5px;">å†²çªè®¾è®¡</button>
                    <button class="tool-btn" onclick="generateClimax()" style="margin: 5px;">é«˜æ½®ç”Ÿæˆ</button>
                    <button class="tool-btn" onclick="generateEnding()" style="margin: 5px;">ç»“å±€å»ºè®®</button>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #667eea;">ğŸ‘¥ è§’è‰²åŠ©æ‰‹</h4>
                    <button class="tool-btn" onclick="deepenCharacter()" style="margin: 5px;">æ·±åŒ–è§’è‰²</button>
                    <button class="tool-btn" onclick="generateDialogue()" style="margin: 5px;">ç”Ÿæˆå¯¹è¯</button>
                    <button class="tool-btn" onclick="characterArc()" style="margin: 5px;">è§’è‰²æˆé•¿çº¿</button>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn-primary" onclick="closeAdvancedTools()">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script src="multi-agent-coordinator.js"></script>
    <script src="agent-planning.js"></script>
    <script src="agent-execution.js"></script>
    <script src="agent-response.js"></script>
    <script src="context-memory-manager.js"></script>
    <script src="memory-manager.js"></script>
    <script src="story-templates.js"></script>
    <script src="story-creation-agent.js"></script>
    <script>
        // åˆå§‹åŒ–å°è¯´åˆ›ä½œç³»ç»Ÿ
        let storyAgent;
        let coordinator;
        let storyTemplates;
        let memoryManager;
        let storyProject = {
            title: '',
            genre: '',
            characters: [],
            plot: [],
            chapters: [],
            settings: {},
            created: new Date().toISOString(),
            modified: new Date().toISOString()
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeStoryCreator();
        });

        function initializeStoryCreator() {
            // åˆå§‹åŒ–è®°å¿†ç®¡ç†å™¨
            try {
                memoryManager = new MemoryManager();
            } catch (error) {
                console.warn('è®°å¿†ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸºç¡€åŠŸèƒ½:', error);
                memoryManager = null;
            }
            
            // åˆå§‹åŒ–æ•…äº‹æ¨¡æ¿åº“
            try {
                storyTemplates = new StoryTemplates();
            } catch (error) {
                console.error('æ•…äº‹æ¨¡æ¿åº“åˆå§‹åŒ–å¤±è´¥:', error);
                storyTemplates = null;
            }
            
            // åˆå§‹åŒ–å¤šä»£ç†åè°ƒå™¨
            try {
                coordinator = new MultiAgentCoordinator();
                
                // åˆå§‹åŒ–å„ä¸ªä»£ç†
                coordinator.initializeAgents({
                    planning: new PlanningAgent(),
                    execution: new ExecutionAgent(),
                    response: new ResponseAgent(),
                    storyCreator: new StoryCreationAgent()
                });
                
                // è·å–å°è¯´åˆ›ä½œä»£ç†
                storyAgent = coordinator.agents.storyCreator;
            } catch (error) {
                console.warn('å¤šä»£ç†åè°ƒå™¨åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ¨¡å¼:', error);
                try {
                    storyAgent = new StoryCreationAgent();
                } catch (agentError) {
                    console.error('å°è¯´åˆ›ä½œä»£ç†åˆå§‹åŒ–å¤±è´¥:', agentError);
                    storyAgent = null;
                }
            }
            
            setupEventListeners();
            loadLocalProject();
            updateProgress();
            
            console.log('ğŸ¯ å°è¯´åˆ›ä½œç³»ç»Ÿå·²åˆå§‹åŒ–');
        }

        function setupEventListeners() {
            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // æ•…äº‹ç±»å‹é€‰æ‹©
            document.querySelectorAll('.genre-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectGenre(this);
                });
            });

            // æ–‡æœ¬è¾“å…¥ç›‘å¬
            document.getElementById('writingArea').addEventListener('input', function() {
                updateWordCount();
                autoSave();
            });

            // èŠå¤©è¾“å…¥æ¡†å›è½¦å‘é€
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // æ›´æ–°å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½å¯¹åº”å†…å®¹
            switch(tabName) {
                case 'characters':
                    loadCharacters();
                    break;
                case 'plot':
                    loadPlotTimeline();
                    break;
                case 'ai-assistant':
                    initializeChat();
                    break;
            }
        }

        function selectGenre(element) {
            document.querySelectorAll('.genre-card').forEach(card => {
                card.classList.remove('selected');
            });
            element.classList.add('selected');
            
            storyProject.genre = element.dataset.genre;
            saveLocalProject();
            generateGenreSuggestions();
        }

        function generateGenreSuggestions() {
            let suggestions = [];
            
            if (storyAgent) {
                try {
                    suggestions = storyAgent.generateCreationSuggestions();
                } catch (error) {
                    console.warn('è·å–åˆ›ä½œå»ºè®®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å»ºè®®:', error);
                    suggestions = [
                        'ä»ä½ ç†Ÿæ‚‰æˆ–æ„Ÿå…´è¶£çš„é¢†åŸŸå¼€å§‹åˆ›ä½œ',
                        'è®¾å®šä¸€ä¸ªæ˜ç¡®çš„å†™ä½œç›®æ ‡å’Œæ—¶é—´è¡¨',
                        'å…ˆå®Œæˆåˆç¨¿ï¼Œå†è¿›è¡Œä¿®æ”¹æ¶¦è‰²',
                        'å¤šé˜…è¯»ä¼˜ç§€ä½œå“ï¼Œç§¯ç´¯åˆ›ä½œç´ æ'
                    ];
                }
            } else {
                suggestions = [
                    'ç¡®å®šä½ çš„æ•…äº‹ç±»å‹å’Œé£æ ¼',
                    'è®¾è®¡å¼•äººå…¥èƒœçš„ä¸»è§’',
                    'æ„å»ºå®Œæ•´çš„æ•…äº‹ä¸–ç•Œ',
                    'åˆ¶å®šæ¸…æ™°çš„å†™ä½œè®¡åˆ’'
                ];
            }
            
            const suggestionList = document.getElementById('outlineSuggestionList');
            
            suggestionList.innerHTML = suggestions.map(suggestion => `
                <div class="suggestion-item">
                    <h4>å»ºè®®</h4>
                    <p>${suggestion}</p>
                </div>
            `).join('');
        }

        function addCharacter() {
            const characterId = 'char_' + Date.now();
            const character = {
                id: characterId,
                name: 'æ–°è§’è‰²',
                role: 'supporting',
                traits: [],
                background: ''
            };

            storyProject.characters.push(character);
            loadCharacters();
            saveLocalProject();
        }

        function loadCharacters() {
            const characterList = document.getElementById('characterList');
            
            if (storyProject.characters.length === 0) {
                characterList.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— è§’è‰²ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p>';
                return;
            }

            characterList.innerHTML = storyProject.characters.map(character => `
                <div class="character-item">
                    <h4>${character.name}</h4>
                    <div class="character-traits">
                        ${character.traits.map(trait => `<span class="trait-tag">${trait}</span>`).join('')}
                    </div>
                    <button class="btn-secondary" onclick="editCharacter('${character.id}')">ç¼–è¾‘</button>
                </div>
            `).join('');
        }

        function loadPlotTimeline() {
            const plotTimeline = document.getElementById('plotTimeline');
            const structure = document.getElementById('plotStructure').value;
            
            let outline = [];
            
            if (storyAgent) {
                try {
                    outline = storyAgent.generatePlotOutline();
                } catch (error) {
                    console.warn('è·å–æƒ…èŠ‚å¤§çº²å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤§çº²:', error);
                    outline = getDefaultPlotOutline();
                }
            } else {
                outline = getDefaultPlotOutline();
            }
            
            plotTimeline.innerHTML = outline.map((point, index) => `
                <div class="plot-point">
                    <h4>${point.phase}</h4>
                    <p>ç¬¬${point.chapter}ç« </p>
                    <p>${point.description}</p>
                    <div>${point.keyEvents.map(event => `<span style="margin-right: 10px;">â€¢ ${event}</span>`).join('')}</div>
                </div>
            `).join('');
        }
        
        function getDefaultPlotOutline() {
            return [
                {
                    phase: 'èµ·å› è®¾å®š',
                    chapter: 1,
                    description: 'ä»‹ç»æ•…äº‹èƒŒæ™¯ï¼Œå»ºç«‹ä¸»è¦è§’è‰²å’Œåˆå§‹æƒ…å¢ƒ',
                    keyEvents: ['è§’è‰²ç™»åœº', 'èƒŒæ™¯è®¾å®š', 'ç›®æ ‡ç¡®ç«‹']
                },
                {
                    phase: 'å‘å±•å¯¹æŠ—',
                    chapter: 5,
                    description: 'å¼•å…¥å†²çªï¼Œè§’è‰²é¢ä¸´æŒ‘æˆ˜å’Œéšœç¢',
                    keyEvents: ['é‡åˆ°å›°éš¾', 'é¢ä¸´é€‰æ‹©', 'è§’è‰²æˆé•¿']
                },
                {
                    phase: 'ç»“å±€è§£å†³',
                    chapter: 10,
                    description: 'è§£å†³å†²çªï¼Œè§’è‰²è·å¾—æˆé•¿ï¼Œæ•…äº‹è¾¾åˆ°é«˜æ½®å¹¶ç»“æŸ',
                    keyEvents: ['å†²çªçˆ†å‘', 'é—®é¢˜è§£å†³', 'ç»“å±€æ”¶å°¾']
                }
            ];
        }

        function updateWordCount() {
            const text = document.getElementById('writingArea').value;
            const wordCount = text.length;
            document.getElementById('wordCount').textContent = wordCount;
            document.getElementById('completedWords').textContent = wordCount;
            
            // æ›´æ–°æ™ºèƒ½åˆ†æ
            if (wordCount > 50) {
                updateWritingStats(text);
            }
            
            // å¦‚æœæœ‰è®°å¿†ç®¡ç†å™¨ï¼Œæ›´æ–°å†™ä½œé£æ ¼åˆ†æ
            if (memoryManager && wordCount > 100) {
                memoryManager.analyzeWritingStyle(text).catch(error => {
                    console.warn('å†™ä½œé£æ ¼åˆ†æå¤±è´¥:', error);
                });
            }
            
            updateProgress();
        }

        function updateWritingStats(text) {
            try {
                // è®¡ç®—å¹³å‡å¥é•¿
                const sentences = text.split(/[ã€‚ï¼ï¼Ÿ.!?]/).filter(s => s.trim());
                const avgLength = sentences.length > 0 ? Math.round(text.length / sentences.length) : 0;
                document.getElementById('avgSentenceLength').textContent = avgLength;

                // åˆ†æé˜…è¯»éš¾åº¦
                let readability = 'ç®€å•';
                if (avgLength > 25) readability = 'å›°éš¾';
                else if (avgLength > 15) readability = 'ä¸­ç­‰';
                document.getElementById('readabilityLevel').textContent = readability;

                // åˆ†ææƒ…æ„Ÿå€¾å‘
                const emotions = analyzeEmotions(text);
                document.getElementById('emotionTone').textContent = emotions;

                // AIè¯„åˆ†æ¨¡æ‹Ÿ
                const score = calculateAIScore(text, avgLength);
                document.getElementById('aiScore').textContent = score;

            } catch (error) {
                console.warn('æ›´æ–°å†™ä½œç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        function analyzeEmotions(text) {
            const emotionWords = {
                'å¿«ä¹': ['å¿«ä¹', 'é«˜å…´', 'æ„‰å¿«', 'å¼€å¿ƒ', 'æ¬¢ä¹', 'å–œæ‚¦'],
                'æ‚²ä¼¤': ['æ‚²ä¼¤', 'éš¾è¿‡', 'ä¼¤å¿ƒ', 'ç—›è‹¦', 'å“€ä¼¤', 'æ‚²ä¼¤'],
                'æ„¤æ€’': ['æ„¤æ€’', 'ç”Ÿæ°”', 'æ¼ç«', 'æš´æ€’', 'æ°”æ„¤', 'æ¼æ€’'],
                'æ¸©æš–': ['æ¸©æš–', 'æ¸©é¦¨', 'äº²åˆ‡', 'æ¸©æŸ”', 'æŸ”å’Œ', 'æ¸©æš–']
            };

            let maxCount = 0;
            let detectedEmotion = 'ä¸­æ€§';

            Object.entries(emotionWords).forEach(([emotion, words]) => {
                const count = words.filter(word => text.includes(word)).length;
                if (count > maxCount) {
                    maxCount = count;
                    detectedEmotion = emotion;
                }
            });

            return detectedEmotion;
        }

        function calculateAIScore(text, avgLength) {
            let score = 3; // åŸºç¡€åˆ†æ•°
            
            // å­—æ•°å¥–åŠ±
            if (text.length > 1000) score++;
            if (text.length > 5000) score++;
            
            // å¥é•¿å¤šæ ·æ€§å¥–åŠ±
            if (avgLength >= 10 && avgLength <= 20) score++;
            
            // è¯æ±‡ä¸°å¯Œåº¦æ£€æŸ¥
            const uniqueWords = new Set(text.split(/\s+/)).size;
            const totalWords = text.split(/\s+/).length;
            const diversity = uniqueWords / totalWords;
            if (diversity > 0.6) score++;
            
            score = Math.max(1, Math.min(5, score));
            return 'â­'.repeat(score);
        }

        function updateProgress() {
            const targetWords = parseInt(document.getElementById('targetWords').value) || 50000;
            const completedWords = parseInt(document.getElementById('completedWords').textContent) || 0;
            const percentage = Math.round((completedWords / targetWords) * 100);
            
            document.getElementById('progressPercentage').textContent = percentage + '%';
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            const chatMessages = document.getElementById('chatMessages');
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            chatMessages.innerHTML += `
                <div class="message user">
                    <div class="message-content">${message}</div>
                </div>
            `;

            input.value = '';

            // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
            chatMessages.innerHTML += `
                <div class="message ai" id="loadingMessage">
                    <div class="message-content">
                        <span class="loading-spinner"></span> æ­£åœ¨æ€è€ƒ...
                    </div>
                </div>
            `;

            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                let relevantMemories = [];
                let personalizedSuggestions = null;
                
                // æœç´¢ç›¸å…³è®°å¿†ï¼ˆå¦‚æœè®°å¿†ç®¡ç†å™¨å¯ç”¨ï¼‰
                if (memoryManager) {
                    try {
                        relevantMemories = await memoryManager.searchRelevantMemory(message);
                        personalizedSuggestions = await memoryManager.generatePersonalizedSuggestions(message);
                    } catch (memError) {
                        console.warn('è®°å¿†æœç´¢å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸºç¡€åŠŸèƒ½:', memError);
                    }
                }
                
                let response;
                
                // ä½¿ç”¨å°è¯´åˆ›ä½œä»£ç†
                if (storyAgent) {
                    response = await storyAgent.processUserInput(message, {
                        storyProject: storyProject,
                        relevantMemories: relevantMemories,
                        personalizedSuggestions: personalizedSuggestions
                    });
                } else {
                    // å¤‡ç”¨å“åº”
                    response = {
                        message: `æˆ‘ç†è§£æ‚¨å…³äº"${message}"çš„æƒ³æ³•ã€‚è®©æˆ‘ä»¬å¼€å§‹åˆ›ä½œå§ï¼å»ºè®®æ‚¨å…ˆè®¾å®šæ•…äº‹çš„åŸºæœ¬è¦ç´ ï¼Œå¦‚è§’è‰²ã€èƒŒæ™¯å’Œæƒ…èŠ‚å¤§çº²ã€‚`,
                        suggestions: ['è®¾å®šæ•…äº‹ç±»å‹', 'åˆ›å»ºä¸»è¦è§’è‰²', 'è§„åˆ’æ•…äº‹å¤§çº²', 'å¼€å§‹å†™ä½œ']
                    };
                }
                
                // åˆ†æç”¨æˆ·å†™ä½œé£æ ¼ï¼ˆå¦‚æœè®°å¿†ç®¡ç†å™¨å¯ç”¨ï¼‰
                if (memoryManager) {
                    const textContent = document.getElementById('writingArea').value;
                    if (textContent.length > 100) {
                        try {
                            await memoryManager.analyzeWritingStyle(textContent);
                        } catch (styleError) {
                            console.warn('å†™ä½œé£æ ¼åˆ†æå¤±è´¥:', styleError);
                        }
                    }
                    
                    // ä¿å­˜å¯¹è¯åˆ°è®°å¿†
                    try {
                        await memoryManager.saveConversation(message, response);
                    } catch (saveError) {
                        console.warn('ä¿å­˜å¯¹è¯è®°å¿†å¤±è´¥:', saveError);
                    }
                }
                
                // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                const loadingMsg = document.getElementById('loadingMessage');
                if (loadingMsg) {
                    loadingMsg.remove();
                }

                // æ·»åŠ è®°å¿†æŒ‡ç¤ºå™¨
                let memoryIndicator = '';
                if (relevantMemories.length > 0) {
                    memoryIndicator = `<div style="font-size: 12px; color: #667eea; margin-top: 5px;">ğŸ§  åŸºäºè®°å¿†åˆ†æ (${relevantMemories.length}æ¡ç›¸å…³è®°å¿†)</div>`;
                }

                // æ·»åŠ AIå“åº”
                chatMessages.innerHTML += `
                    <div class="message ai">
                        <div class="message-content">${formatAIResponse(response)}</div>
                        ${memoryIndicator}
                    </div>
                `;

                chatMessages.scrollTop = chatMessages.scrollHeight;

            } catch (error) {
                console.error('AIå“åº”é”™è¯¯:', error);
                
                // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                const loadingMsg = document.getElementById('loadingMessage');
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                chatMessages.innerHTML += `
                    <div class="message ai">
                        <div class="message-content">
                            æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯·æ±‚æ—¶é‡åˆ°äº†é—®é¢˜ã€‚è¯·ç¨åé‡è¯•ã€‚
                        </div>
                    </div>
                `;
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function formatAIResponse(response) {
            if (typeof response === 'object') {
                switch(response.type) {
                    case 'story_creation':
                        return `
                            <h4>ğŸ¯ åˆ›ä½œå»ºè®®</h4>
                            <ul>
                                ${response.suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                            <h4>ğŸ¤” å¼•å¯¼é—®é¢˜</h4>
                            <ul>
                                ${response.questions.map(q => `<li>${q}</li>`).join('')}
                            </ul>
                        `;
                    case 'character_development':
                        return `
                            <h4>ğŸ‘¥ è§’è‰²å‘å±•å»ºè®®</h4>
                            <p>è¯·æä¾›æ›´å¤šè§’è‰²ä¿¡æ¯ï¼Œæˆ‘å°†å¸®åŠ©ä½ å¡‘é€ ä¸°æ»¡çš„äººç‰©å½¢è±¡ã€‚</p>
                        `;
                    case 'plot_planning':
                        return `
                            <h4>ğŸ“ˆ æƒ…èŠ‚è§„åˆ’</h4>
                            <p>æˆ‘æ¥å¸®ä½ è§„åˆ’æ•…äº‹æƒ…èŠ‚ï¼Œè®©æ•…äº‹æ›´åŠ å¼•äººå…¥èƒœã€‚</p>
                        `;
                    default:
                        return response.message || 'æˆ‘ç†è§£äº†ï¼Œè®©æˆ‘ä»¬ç»§ç»­åˆ›ä½œå§ï¼';
                }
            }
            return response;
        }

        function initializeChat() {
            const chatMessages = document.getElementById('chatMessages');
            
            if (chatMessages.children.length === 0) {
                chatMessages.innerHTML = `
                    <div class="message ai">
                        <div class="message-content">
                            ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåˆ›ä½œåŠ©æ‰‹ ğŸ¤–<br><br>
                            æˆ‘å¯ä»¥å¸®åŠ©ä½ ï¼š<br>
                            â€¢ æ„æ€æ•…äº‹æƒ…èŠ‚<br>
                            â€¢ è®¾è®¡è§’è‰²æ€§æ ¼<br>
                            â€¢ æä¾›å†™ä½œå»ºè®®<br>
                            â€¢ ç»­å†™æ•…äº‹å†…å®¹<br>
                            â€¢ æ¶¦è‰²å’Œä¼˜åŒ–æ–‡å­—<br><br>
                            ä½ å¸Œæœ›ä»å“ªé‡Œå¼€å§‹å‘¢ï¼Ÿ
                        </div>
                    </div>
                `;
            }
        }

        function saveLocalProject() {
            storyProject.modified = new Date().toISOString();
            localStorage.setItem('storyProject', JSON.stringify(storyProject));
        }

        function loadLocalProject() {
            const saved = localStorage.getItem('storyProject');
            if (saved) {
                storyProject = JSON.parse(saved);
                
                // æ¢å¤UIçŠ¶æ€
                if (storyProject.title) {
                    document.getElementById('storyTitle').value = storyProject.title;
                }
                if (storyProject.genre) {
                    document.querySelector(`[data-genre="${storyProject.genre}"]`).click();
                }
                if (storyProject.settings) {
                    Object.assign(document.getElementById, storyProject.settings);
                }
            }
        }

        function autoSave() {
            saveLocalProject();
        }

        function startCreation() {
            const title = document.getElementById('storyTitle').value;
            if (!title) {
                alert('è¯·å…ˆè¾“å…¥æ•…äº‹æ ‡é¢˜');
                return;
            }

            storyProject.title = title;
            saveLocalProject();

            // åˆ‡æ¢åˆ°å†™ä½œæ ‡ç­¾é¡µ
            switchTab('writing');

            // æ˜¾ç¤ºå¼€å§‹æç¤º
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="message ai">
                    <div class="message-content">
                        å¤ªæ£’äº†ï¼ã€Š${title}ã€‹çš„åˆ›ä½œä¹‹æ—…å¼€å§‹äº† ğŸš€<br><br>
                        ä½ å¯ä»¥å¼€å§‹åœ¨å†™ä½œåŒºåŸŸåˆ›ä½œï¼Œæˆ–è€…å‘æˆ‘è¯¢é—®å»ºè®®ã€‚è®°ä½ï¼Œæœ€é‡è¦çš„æ˜¯äº«å—åˆ›ä½œçš„è¿‡ç¨‹ï¼
                    </div>
                </div>
            `;

            switchTab('ai-assistant');
        }

        function saveProject() {
            saveLocalProject();
            alert('é¡¹ç›®å·²ä¿å­˜åˆ°æœ¬åœ°');
        }

        function loadProject() {
            // å®ç°é¡¹ç›®åŠ è½½åŠŸèƒ½
            console.log('åŠ è½½é¡¹ç›®åŠŸèƒ½å¾…å®ç°');
        }

        function exportStory() {
            const content = document.getElementById('writingArea').value;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${storyProject.title || 'æœªå‘½åæ•…äº‹'}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function shareProject() {
            // å®ç°åˆ†äº«åŠŸèƒ½
            const shareData = {
                title: storyProject.title || 'æœªå‘½åæ•…äº‹',
                content: document.getElementById('writingArea').value.substring(0, 500),
                url: window.location.href
            };
            
            if (navigator.share) {
                navigator.share(shareData).catch(err => console.log('åˆ†äº«å¤±è´¥:', err));
            } else {
                // å¤åˆ¶åˆ°å‰ªè´´æ¿ä½œä¸ºå¤‡é€‰
                const text = `${shareData.title}\n\n${shareData.content}\n\n${shareData.url}`;
                navigator.clipboard.writeText(text).then(() => {
                    alert('æ•…äº‹é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }).catch(() => {
                    alert('åˆ†äº«åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨');
                });
            }
        }

        function previewStory() {
            const content = document.getElementById('writingArea').value;
            const title = storyProject.title || 'æœªå‘½åæ•…äº‹';
            
            // åˆ›å»ºé¢„è§ˆçª—å£
            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title} - é¢„è§ˆ</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.8; max-width: 800px; margin: 0 auto; padding: 40px 20px; }
                        h1 { color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
                        .stats { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 30px; }
                        .content { white-space: pre-wrap; color: #444; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div class="stats">
                        <strong>å­—æ•°ï¼š</strong>${content.length} | 
                        <strong>åˆ›ä½œæ—¶é—´ï¼š</strong>${new Date().toLocaleString()}
                    </div>
                    <div class="content">${content}</div>
                </body>
                </html>
            `);
            previewWindow.document.close();
        }
        
        function showContextInfo() {
            if (!memoryManager) {
                alert('è®°å¿†ç®¡ç†å™¨æœªåˆå§‹åŒ–');
                return;
            }
            
            const stats = memoryManager.getMemoryStats();
            alert(`è®°å¿†ç»Ÿè®¡ï¼š\nå¯¹è¯è®°å½•ï¼š${stats.conversations}æ¡\næ•…äº‹è®°å¿†ï¼š${stats.stories}æ¡\nè§’è‰²è®°å¿†ï¼š${stats.characters}æ¡\nåœºæ™¯è®°å¿†ï¼š${stats.settings}æ¡\n\n${stats.isMemOSAvailable ? 'ä½¿ç”¨MemOSäº‘è®°å¿†' : 'ä½¿ç”¨æœ¬åœ°è®°å¿†'}`);
        }
        
        async function searchContext() {
            const query = prompt('è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼š');
            if (!query || !memoryManager) return;
            
            try {
                const results = await memoryManager.searchRelevantMemory(query);
                if (results.length === 0) {
                    alert('æœªæ‰¾åˆ°ç›¸å…³è®°å¿†');
                } else {
                    const resultText = results.slice(0, 5).map((result, index) => 
                        `${index + 1}. ${result.type}: ${result.content.substring(0, 100)}...`
                    ).join('\n\n');
                    alert(`æ‰¾åˆ° ${results.length} æ¡ç›¸å…³è®°å¿†ï¼š\n\n${resultText}`);
                }
            } catch (error) {
                alert('æœç´¢å¤±è´¥ï¼š' + error.message);
            }
        }

        function formatText(format) {
            const textarea = document.getElementById('writingArea');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (!selectedText) {
                alert('è¯·å…ˆé€‰æ‹©è¦æ ¼å¼åŒ–çš„æ–‡æœ¬');
                return;
            }

            let formattedText = selectedText;
            switch(format) {
                case 'bold':
                    formattedText = `**${selectedText}**`;
                    break;
                case 'italic':
                    formattedText = `*${selectedText}*`;
                    break;
            }

            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
            updateWordCount();
        }

        function insertChapter() {
            const textarea = document.getElementById('writingArea');
            const chapterNumber = (storyProject.chapters.length + 1);
            const chapterTitle = `ç¬¬${chapterNumber}ç« `;
            const chapterText = `\n\n${chapterTitle}\n\n`;
            
            const cursorPos = textarea.selectionStart;
            textarea.value = textarea.value.substring(0, cursorPos) + chapterText + textarea.value.substring(cursorPos);
            
            storyProject.chapters.push({
                number: chapterNumber,
                title: chapterTitle,
                content: '',
                wordCount: 0
            });
            
            document.getElementById('currentChapter').textContent = chapterNumber;
            saveLocalProject();
            updateWordCount();
        }

        async function aiContinue() {
            const currentText = document.getElementById('writingArea').value;
            
            if (!currentText) {
                alert('è¯·å…ˆå†™ä¸€äº›å†…å®¹ï¼ŒAIæ‰èƒ½åŸºäºç°æœ‰å†…å®¹ç»§ç»­åˆ›ä½œ');
                return;
            }

            let response;
            if (storyAgent) {
                try {
                    response = await storyAgent.processUserInput('è¯·ç»§ç»­å†™ä¸‹å»', {
                        originalText: currentText
                    });
                } catch (error) {
                    console.warn('AIç»­å†™å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç»­å†™:', error);
                    response = {
                        content: generateContinuation(currentText)
                    };
                }
            } else {
                response = {
                    content: generateContinuation(currentText)
                };
            }

            if (response.content) {
                const textarea = document.getElementById('writingArea');
                textarea.value += '\n\n' + response.content;
                updateWordCount();
            }
        }
        
        function generateContinuation(text) {
            const continuations = [
                'å°±åœ¨è¿™æ—¶ï¼Œä¸€ä¸ªæ„æƒ³ä¸åˆ°çš„è½¬æŠ˜å‘ç”Ÿäº†...',
                'æ•…äº‹çš„è¿›ç¨‹åœ¨è¿™é‡Œå‡ºç°äº†æ–°çš„å˜åŒ–...',
                'éšç€æƒ…èŠ‚çš„å‘å±•ï¼Œä¸»è§’é¢ä¸´äº†æ–°çš„é€‰æ‹©...',
                'æ—¶é—´åœ¨è¿™ä¸€åˆ»ä»¿ä½›é™æ­¢äº†...',
                'è¿œæ–¹ä¼ æ¥äº†æ‰“ç ´å¯‚é™çš„å£°éŸ³...'
            ];
            
            return continuations[Math.floor(Math.random() * continuations.length)];
        }

        // æ¨¡æ¿ç›¸å…³åŠŸèƒ½
        let currentTemplate = null;

        function loadTemplates() {
            const templateCategories = document.getElementById('templateCategories');
            const templateList = document.getElementById('templateList');
            
            if (!storyTemplates) {
                templateCategories.innerHTML = '<p style="color: #999;">æ¨¡æ¿åº“æš‚æ—¶ä¸å¯ç”¨</p>';
                templateList.innerHTML = '<p style="color: #999;">è¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
                return;
            }
            
            try {
                // ç”Ÿæˆåˆ†ç±»
                let categoriesHTML = '';
                for (const [genre, genreData] of Object.entries(storyTemplates.templates)) {
                    categoriesHTML += `
                        <div class="template-category" onclick="selectGenre('${genre}')">
                            <h4>${genreData.name}</h4>
                            <p>${genreData.templates.length} ä¸ªæ¨¡æ¿</p>
                        </div>
                    `;
                }
                templateCategories.innerHTML = categoriesHTML;
                
                // é»˜è®¤åŠ è½½æ‰€æœ‰æ¨¡æ¿
                loadAllTemplates();
            } catch (error) {
                console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
                templateCategories.innerHTML = '<p style="color: #999;">æ¨¡æ¿åŠ è½½å¤±è´¥</p>';
                templateList.innerHTML = '<p style="color: #999;">è¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
            }
        }

        function loadAllTemplates() {
            const templateList = document.getElementById('templateList');
            let templatesHTML = '';
            
            for (const [genre, genreData] of Object.entries(storyTemplates.templates)) {
                for (const template of genreData.templates) {
                    templatesHTML += createTemplateCard(template, genre);
                }
            }
            
            templateList.innerHTML = templatesHTML || '<p style="text-align: center; color: #999;">æš‚æ— æ¨¡æ¿</p>';
        }

        function createTemplateCard(template, genre) {
            return `
                <div class="template-card" onclick="showTemplateDetails('${genre}', '${template.id}')">
                    <h4>${template.title}</h4>
                    <p>${template.description}</p>
                    <div class="template-tags">
                        <span class="template-tag">${genre}</span>
                        <span class="template-tag">å®Œæ•´ç»“æ„</span>
                    </div>
                </div>
            `;
        }

        function selectGenre(genre) {
            // æ›´æ–°åˆ†ç±»é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.template-category').forEach(card => {
                card.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // åŠ è½½è¯¥ç±»å‹çš„æ¨¡æ¿
            const templateList = document.getElementById('templateList');
            const templates = storyTemplates.getTemplatesByGenre(genre);
            
            let templatesHTML = '';
            templates.forEach(template => {
                templatesHTML += createTemplateCard(template, genre);
            });
            
            templateList.innerHTML = templatesHTML;
        }

        function showTemplateDetails(genre, templateId) {
            const template = storyTemplates.getTemplate(genre, templateId);
            if (!template) return;
            
            currentTemplate = { genre, ...template };
            
            // éšè—æ¨¡æ¿åˆ—è¡¨ï¼Œæ˜¾ç¤ºè¯¦æƒ…
            document.getElementById('templateList').style.display = 'none';
            document.getElementById('templateCategories').style.display = 'none';
            document.getElementById('templateDetails').style.display = 'block';
            
            // å¡«å……æ¨¡æ¿è¯¦æƒ…
            document.getElementById('templateTitle').textContent = template.title;
            document.getElementById('templateDescription').textContent = template.description;
            
            // æ˜¾ç¤ºç»“æ„
            const structureHTML = Object.entries(template.structure).map(([phase, description]) => `
                <div class="structure-phase">
                    <h6>${phase}</h6>
                    <p>${description}</p>
                </div>
            `).join('');
            document.getElementById('templateStructure').innerHTML = structureHTML;
            
            // æ˜¾ç¤ºå…ƒç´ 
            const elementsHTML = Object.entries(template.elements).map(([category, items]) => `
                <div class="element-group">
                    <h6>${getCategoryName(category)}</h6>
                    <p>${items.join('ã€')}</p>
                </div>
            `).join('');
            document.getElementById('templateElements').innerHTML = elementsHTML;
        }

        function getCategoryName(category) {
            const names = {
                characters: 'è§’è‰²',
                settings: 'åœºæ™¯',
                conflicts: 'å†²çª'
            };
            return names[category] || category;
        }

        function useTemplate() {
            if (!currentTemplate) return;
            
            // åº”ç”¨æ¨¡æ¿åˆ°é¡¹ç›®
            storyProject.template = currentTemplate;
            storyProject.genre = currentTemplate.genre;
            
            // æ›´æ–°UI
            document.getElementById('storyTitle').value = currentTemplate.title;
            selectGenreCard(currentTemplate.genre);
            
            // è¿”å›åˆ°ä¸»ç•Œé¢
            document.getElementById('templateDetails').style.display = 'none';
            document.getElementById('templateList').style.display = 'grid';
            document.getElementById('templateCategories').style.display = 'grid';
            
            // åˆ‡æ¢åˆ°å¤§çº²æ ‡ç­¾é¡µ
            switchTab('outline');
            
            // å¡«å……å¤§çº²ä¿¡æ¯
            document.getElementById('storySummary').value = currentTemplate.description;
            
            alert('æ¨¡æ¿å·²åº”ç”¨ï¼ä½ å¯ä»¥åŸºäºæ­¤æ¨¡æ¿å¼€å§‹åˆ›ä½œã€‚');
        }

        function selectGenreCard(genre) {
            document.querySelectorAll('.genre-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.genre === genre) {
                    card.classList.add('selected');
                }
            });
        }

        function searchTemplates() {
            const keyword = document.getElementById('templateSearch').value.toLowerCase();
            const filterGenre = document.getElementById('templateGenreFilter').value;
            
            const templateList = document.getElementById('templateList');
            let templatesHTML = '';
            
            for (const [genre, genreData] of Object.entries(storyTemplates.templates)) {
                if (filterGenre && genre !== filterGenre) continue;
                
                for (const template of genreData.templates) {
                    if (keyword && !template.title.toLowerCase().includes(keyword) && 
                        !template.description.toLowerCase().includes(keyword)) {
                        continue;
                    }
                    
                    templatesHTML += createTemplateCard(template, genre);
                }
            }
            
            templateList.innerHTML = templatesHTML || '<p style="text-align: center; color: #999;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ¨¡æ¿</p>';
        }

        function filterTemplates() {
            searchTemplates();
        }

        // ç´ æç›¸å…³åŠŸèƒ½
        function showMaterialTab(tab) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.material-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // åŠ è½½ç´ æå†…å®¹
            const materialsContent = document.getElementById('materialsContent');
            let contentHTML = '';
            
            switch(tab) {
                case 'characters':
                    contentHTML = generateCharacterMaterials();
                    break;
                case 'settings':
                    contentHTML = generateSettingMaterials();
                    break;
                case 'inspirations':
                    contentHTML = generateInspirationMaterials();
                    break;
            }
            
            materialsContent.innerHTML = contentHTML;
        }

        function generateCharacterMaterials() {
            return `
                <div class="material-item">
                    <h5>éšæœºè§’è‰²ç”Ÿæˆå™¨</h5>
                    <p>åŸºäºåŸå‹å’Œç‰¹è´¨ç”Ÿæˆå®Œæ•´è§’è‰²</p>
                    <button class="generate-btn" onclick="generateRandomCharacter()">ç”Ÿæˆè§’è‰²</button>
                </div>
                <div class="material-item">
                    <h5>è§’è‰²åå­—</h5>
                    <p>ä¸­æ–‡ã€è‹±æ–‡ã€å¥‡å¹»é£æ ¼åå­—åº“</p>
                    <button class="generate-btn" onclick="generateRandomName()">ç”Ÿæˆåå­—</button>
                </div>
                <div class="character-item" id="characterPreview" style="display: none;">
                    <!-- åŠ¨æ€ç”Ÿæˆè§’è‰²é¢„è§ˆ -->
                </div>
            `;
        }

        function generateSettingMaterials() {
            return `
                <div class="material-item">
                    <h5>åœºæ™¯ç”Ÿæˆå™¨</h5>
                    <p>åŸºäºç±»å‹å’Œæ°›å›´ç”Ÿæˆåœºæ™¯</p>
                    <button class="generate-btn" onclick="generateRandomSetting()">ç”Ÿæˆåœºæ™¯</button>
                </div>
                <div class="material-item">
                    <h5>åœ°ç‚¹ç´ æ</h5>
                    <p>åŸå¸‚ã€ä¹¡æ‘ã€å¥‡å¹»åœ°ç‚¹</p>
                    <button class="generate-btn" onclick="generateRandomPlace()">ç”Ÿæˆåœ°ç‚¹</button>
                </div>
            `;
        }

        function generateInspirationMaterials() {
            return `
                <div class="material-item">
                    <h5>å†™ä½œæç¤º</h5>
                    <p>æ¿€å‘åˆ›é€ åŠ›çš„å†™ä½œæç¤º</p>
                    <button class="generate-btn" onclick="getWritingPrompt()">è·å–æç¤º</button>
                </div>
                <div class="material-item">
                    <h5>æ•…äº‹å¼€å¤´</h5>
                    <p>å¼•äººå…¥èƒœçš„æ•…äº‹å¼€åœºç™½</p>
                    <button class="generate-btn" onclick="getStoryHook()">è·å–å¼€å¤´</button>
                </div>
            `;
        }

        function generateRandomCharacter() {
            let character;
            
            if (storyTemplates) {
                try {
                    character = storyTemplates.generateCharacter();
                } catch (error) {
                    console.warn('ç”Ÿæˆè§’è‰²å¤±è´¥ï¼Œä½¿ç”¨ç®€å•è§’è‰²:', error);
                    character = generateSimpleCharacter();
                }
            } else {
                character = generateSimpleCharacter();
            }
            
            const preview = document.getElementById('characterPreview');
            
            preview.innerHTML = `
                <h4>${character.name}</h4>
                <div class="character-traits">
                    <span class="trait-tag">${getArchetypeName(character.archetype)}</span>
                    <span class="trait-tag">${character.personality?.mbti || 'æœªçŸ¥'}</span>
                    <span class="trait-tag">${character.background?.socialClass || 'å¹³æ°‘'}</span>
                </div>
                <button class="btn-secondary" onclick="addCharacterToProject('${character.name}')">æ·»åŠ åˆ°é¡¹ç›®</button>
            `;
            
            preview.style.display = 'block';
        }
        
        function generateSimpleCharacter() {
            const names = ['ææ˜', 'ç‹èŠ³', 'å¼ å¼º', 'åˆ˜ä¸½', 'é™ˆæ°', 'æ¨é›ª'];
            const archetypes = ['hero', 'mentor', 'villain', 'sidekick', 'love_interest'];
            const socialClasses = ['è´µæ—', 'ä¸­äº§é˜¶çº§', 'å¹³æ°‘', 'è´«æ°‘'];
            
            return {
                name: names[Math.floor(Math.random() * names.length)],
                archetype: archetypes[Math.floor(Math.random() * archetypes.length)],
                personality: {
                    mbti: 'INTJ'
                },
                background: {
                    socialClass: socialClasses[Math.floor(Math.random() * socialClasses.length)]
                }
            };
        }

        function getArchetypeName(archetype) {
            const names = {
                hero: 'è‹±é›„',
                mentor: 'å¯¼å¸ˆ',
                villain: 'åæ´¾',
                sidekick: 'ä¼™ä¼´',
                love_interest: 'æ‹äºº'
            };
            return names[archetype] || archetype;
        }

        function generateRandomName() {
            let name;
            if (storyTemplates) {
                try {
                    name = storyTemplates.getRandomMaterial('names');
                } catch (error) {
                    console.warn('è·å–éšæœºåå­—å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åå­—:', error);
                    name = ['ææ˜', 'ç‹èŠ³', 'å¼ å¼º', 'åˆ˜ä¸½'][Math.floor(Math.random() * 4)];
                }
            } else {
                name = ['ææ˜', 'ç‹èŠ³', 'å¼ å¼º', 'åˆ˜ä¸½'][Math.floor(Math.random() * 4)];
            }
            alert(`éšæœºåå­—ï¼š${name}`);
        }

        function generateRandomSetting() {
            let setting;
            if (storyTemplates) {
                try {
                    setting = storyTemplates.generateSceneSetting();
                } catch (error) {
                    console.warn('ç”Ÿæˆåœºæ™¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åœºæ™¯:', error);
                    setting = { description: 'ä¸€ä¸ªå®é™çš„åœ°æ–¹', atmosphere: 'å¹³é™' };
                }
            } else {
                setting = { description: 'ä¸€ä¸ªå®é™çš„åœ°æ–¹', atmosphere: 'å¹³é™' };
            }
            alert(`åœºæ™¯ï¼š${setting.description}\næ°›å›´ï¼š${setting.atmosphere}`);
        }

        function generateRandomPlace() {
            let place;
            if (storyTemplates) {
                try {
                    place = storyTemplates.getRandomMaterial('places');
                } catch (error) {
                    console.warn('è·å–éšæœºåœ°ç‚¹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åœ°ç‚¹:', error);
                    place = 'åŸå¸‚è¡—é“';
                }
            } else {
                place = 'åŸå¸‚è¡—é“';
            }
            alert(`åœ°ç‚¹ï¼š${place}`);
        }

        function getWritingPrompt() {
            let prompt;
            if (storyTemplates) {
                try {
                    prompt = storyTemplates.getRandomMaterial('inspirations', 'writingPrompts');
                } catch (error) {
                    console.warn('è·å–å†™ä½œæç¤ºå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æç¤º:', error);
                    prompt = 'å¦‚æœæ—¶é—´å¯ä»¥å€’æµï¼Œä½ ä¼šæ”¹å˜ä»€ä¹ˆï¼Ÿ';
                }
            } else {
                prompt = 'å¦‚æœæ—¶é—´å¯ä»¥å€’æµï¼Œä½ ä¼šæ”¹å˜ä»€ä¹ˆï¼Ÿ';
            }
            alert(`å†™ä½œæç¤ºï¼š${prompt}`);
        }

        function getStoryHook() {
            let hook;
            if (storyTemplates) {
                try {
                    hook = storyTemplates.getRandomMaterial('inspirations', 'storyHooks');
                } catch (error) {
                    console.warn('è·å–æ•…äº‹å¼€å¤´å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¼€å¤´:', error);
                    hook = 'ä¸€å°ç¥ç§˜çš„ä¿¡ä»¶æ”¹å˜äº†ä¸€åˆ‡';
                }
            } else {
                hook = 'ä¸€å°ç¥ç§˜çš„ä¿¡ä»¶æ”¹å˜äº†ä¸€åˆ‡';
            }
            alert(`æ•…äº‹å¼€å¤´ï¼š${hook}`);
        }

        function addCharacterToProject(characterName) {
            const character = {
                id: 'char_' + Date.now(),
                name: characterName,
                role: 'supporting',
                traits: [],
                background: ''
            };
            
            storyProject.characters.push(character);
            loadCharacters();
            saveLocalProject();
            
            alert(`è§’è‰² "${characterName}" å·²æ·»åŠ åˆ°é¡¹ç›®ï¼`);
        }

        // åœ¨æ ‡ç­¾é¡µåˆ‡æ¢æ—¶åŠ è½½æ¨¡æ¿
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            
            if (tabName === 'templates') {
                loadTemplates();
            }
        };

        // é«˜çº§AIå·¥å…·å‡½æ•°
        function showAdvancedTools() {
            document.getElementById('advancedToolsModal').style.display = 'block';
        }

        function closeAdvancedTools() {
            document.getElementById('advancedToolsModal').style.display = 'none';
        }

        function adjustStyle(style) {
            const textarea = document.getElementById('writingArea');
            const selectedText = getSelectedText(textarea) || textarea.value;
            
            if (!selectedText.trim()) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡æœ¬æˆ–ç¡®ä¿æœ‰å†…å®¹');
                return;
            }

            const stylePrompts = {
                romantic: 'è¯·å°†ä»¥ä¸‹æ–‡æœ¬æ”¹å†™å¾—æ›´æµªæ¼«ã€æ›´å¯Œæœ‰æƒ…æ„Ÿè‰²å½©ï¼š',
                suspenseful: 'è¯·å°†ä»¥ä¸‹æ–‡æœ¬æ”¹å†™å¾—æ›´æ‚¬ç–‘ã€æ›´ç´§å¼ ï¼š',
                humorous: 'è¯·å°†ä»¥ä¸‹æ–‡æœ¬æ”¹å†™å¾—æ›´å¹½é»˜ã€æ›´è½»æ¾ï¼š',
                formal: 'è¯·å°†ä»¥ä¸‹æ–‡æœ¬æ”¹å†™å¾—æ›´æ­£å¼ã€æ›´ä¹¦é¢åŒ–ï¼š'
            };

            applyAIEdit(stylePrompts[style], selectedText);
        }

        function enhanceContent(type) {
            const textarea = document.getElementById('writingArea');
            const selectedText = getSelectedText(textarea) || textarea.value;
            
            if (!selectedText.trim()) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡æœ¬æˆ–ç¡®ä¿æœ‰å†…å®¹');
                return;
            }

            const enhancePrompts = {
                descriptions: 'è¯·ä¸ºä»¥ä¸‹æ–‡æœ¬å¢åŠ æ›´ä¸°å¯Œçš„ç¯å¢ƒæå†™å’Œç»†èŠ‚ï¼š',
                dialogues: 'è¯·ä¼˜åŒ–ä»¥ä¸‹æ–‡æœ¬ä¸­çš„å¯¹è¯ï¼Œä½¿å…¶æ›´è‡ªç„¶ã€æ›´æœ‰ä¸ªæ€§ï¼š',
                emotions: 'è¯·æ·±åŒ–ä»¥ä¸‹æ–‡æœ¬ä¸­çš„æƒ…æ„Ÿè¡¨è¾¾ï¼š',
                pacing: 'è¯·è°ƒæ•´ä»¥ä¸‹æ–‡æœ¬çš„èŠ‚å¥å’ŒéŸµå¾‹ï¼š'
            };

            applyAIEdit(enhancePrompts[type], selectedText);
        }

        function generatePlotTwist() {
            const currentText = document.getElementById('writingArea').value;
            const prompt = `åŸºäºå½“å‰æ•…äº‹å†…å®¹ï¼Œè¯·ç”Ÿæˆä¸€ä¸ªæ„æƒ³ä¸åˆ°çš„æƒ…èŠ‚è½¬æŠ˜ï¼š${currentText.substring(0, 500)}`;
            
            getAIResponse(prompt).then(response => {
                insertAtCursor(`\n\nã€æƒ…èŠ‚è½¬æŠ˜å»ºè®®ã€‘${response}\n\n`);
            });
        }

        function generateConflict() {
            const prompt = 'è¯·ä¸ºå½“å‰æ•…äº‹è®¾è®¡ä¸€ä¸ªæœ‰æ„ä¹‰çš„å†²çªåœºæ™¯ï¼š';
            
            getAIResponse(prompt).then(response => {
                insertAtCursor(`\n\nã€å†²çªåœºæ™¯ã€‘${response}\n\n`);
            });
        }

        function generateClimax() {
            const currentText = document.getElementById('writingArea').value;
            const prompt = `åŸºäºå½“å‰æ•…äº‹å‘å±•ï¼Œè¯·ç”Ÿæˆä¸€ä¸ªé«˜æ½®åœºæ™¯ï¼š${currentText.substring(0, 500)}`;
            
            getAIResponse(prompt).then(response => {
                insertAtCursor(`\n\nã€é«˜æ½®åœºæ™¯ã€‘${response}\n\n`);
            });
        }

        function generateEnding() {
            const currentText = document.getElementById('writingArea').value;
            const prompt = `åŸºäºå½“å‰æ•…äº‹ï¼Œè¯·æä¾›å‡ ä¸ªå¯èƒ½çš„ç»“å±€æ–¹å‘ï¼š${currentText.substring(0, 500)}`;
            
            getAIResponse(prompt).then(response => {
                insertAtCursor(`\n\nã€ç»“å±€å»ºè®®ã€‘${response}\n\n`);
            });
        }

        function deepenCharacter() {
            const prompt = 'è¯·æä¾›æ·±åŒ–è§’è‰²å¡‘é€ çš„å»ºè®®å’Œæ–¹æ³•ï¼š';
            
            getAIResponse(prompt).then(response => {
                alert(`è§’è‰²æ·±åŒ–å»ºè®®ï¼š\n${response}`);
            });
        }

        function generateDialogue() {
            const prompt = 'è¯·ç”Ÿæˆä¸€æ®µç”ŸåŠ¨çš„å¯¹è¯åœºæ™¯ï¼ŒåŒ…å«ä¸¤ä¸ªæ€§æ ¼ä¸åŒçš„è§’è‰²ï¼š';
            
            getAIResponse(prompt).then(response => {
                insertAtCursor(`\n\n${response}\n\n`);
            });
        }

        function characterArc() {
            const prompt = 'è¯·è®¾è®¡ä¸€ä¸ªå®Œæ•´çš„è§’è‰²æˆé•¿å¼§çº¿ï¼š';
            
            getAIResponse(prompt).then(response => {
                alert(`è§’è‰²æˆé•¿çº¿è®¾è®¡ï¼š\n${response}`);
            });
        }

        // è¾…åŠ©å‡½æ•°
        function getSelectedText(textarea) {
            return textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
        }

        function insertAtCursor(text) {
            const textarea = document.getElementById('writingArea');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            
            textarea.value = textarea.value.substring(0, start) + text + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + text.length;
            updateWordCount();
        }

        async function applyAIEdit(prompt, text) {
            try {
                const response = await getAIResponse(prompt + text);
                
                if (storyAgent) {
                    const aiResponse = await storyAgent.processUserInput(prompt + text, {
                        originalText: text,
                        task: 'edit'
                    });
                    
                    if (aiResponse.content || aiResponse.message) {
                        insertAtCursor(aiResponse.content || aiResponse.message);
                        return;
                    }
                }
                
                // å¤‡ç”¨æ–¹æ¡ˆ
                insertAtCursor(`\n\nã€AIç¼–è¾‘ç»“æœã€‘${response}\n\n`);
                
            } catch (error) {
                console.warn('AIç¼–è¾‘å¤±è´¥:', error);
                insertAtCursor(`\n\nã€ç¼–è¾‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•\n\n`);
            }
        }

        async function getAIResponse(prompt) {
            if (storyAgent) {
                try {
                    const response = await storyAgent.processUserInput(prompt, {});
                    return response.content || response.message || 'å¤„ç†ä¸­...';
                } catch (error) {
                    console.warn('AIå“åº”å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å“åº”:', error);
                }
            }
            
            // é»˜è®¤å“åº”
            return 'AIåŠ©æ‰‹æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚ï¼Œè¯·ç¨å€™...';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('advancedToolsModal');
            if (event.target === modal) {
                closeAdvancedTools();
            }
        });
    </script>
</body>
</html>