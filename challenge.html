<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯æŒ‘æˆ˜ - å•è¯å†’é™©å²›</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/word-adventure.css">
</head>
<body>
    <div class="page-container challenge-page">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <header class="page-header challenge-header">
            <button class="back-btn" onclick="goBack()">â†</button>
            <h1 id="challenge-title">å•è¯æŒ‘æˆ˜</h1>
            <div class="challenge-info">
                <span class="score-display">å¾—åˆ†: <span id="current-score">0</span></span>
                <span class="lives-display">ç”Ÿå‘½: <span id="current-lives">â¤ï¸â¤ï¸â¤ï¸</span></span>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content challenge-content">
            <!-- æŒ‘æˆ˜å‡†å¤‡é˜¶æ®µ -->
            <section id="challenge-prep" class="challenge-preparation">
                <div class="prep-content">
                    <div class="word-preview">
                        <h2>å­¦ä¹ æ–°å•è¯</h2>
                        <div class="word-card">
                            <div class="word-main" id="preview-word">Loading...</div>
                            <div class="word-phonetic" id="preview-phonetic">Loading...</div>
                            <div class="word-chinese" id="preview-chinese">Loading...</div>
                            <div class="word-mnemonic" id="preview-mnemonic">Loading...</div>
                            <div class="word-association" id="preview-association">Loading...</div>
                        </div>
                    </div>
                    
                    <div class="prep-actions">
                        <button class="primary-btn" id="play-pronunciation" onclick="playWordPronunciation()">
                            ğŸ”Š æ’­æ”¾å‘éŸ³
                        </button>
                        <button class="secondary-btn" id="start-practice" onclick="startPractice()">
                            å¼€å§‹ç»ƒä¹ 
                        </button>
                    </div>
                </div>
            </section>

            <!-- æŒ‘æˆ˜è¿›è¡Œé˜¶æ®µ -->
            <section id="challenge-active" class="challenge-active" style="display: none;">
                <div class="challenge-header">
                    <div class="challenge-type" id="challenge-type">å‘éŸ³æŒ‘æˆ˜</div>
                    <div class="challenge-timer">
                        <span id="timer-display">â±ï¸ 60</span>
                        <div class="timer-bar">
                            <div class="timer-fill" id="timer-fill"></div>
                        </div>
                    </div>
                </div>

                <div class="challenge-area" id="challenge-area">
                    <!-- æŒ‘æˆ˜å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="challenge-tools">
                    <button class="tool-btn" id="hint-btn" onclick="useHint()" title="ä½¿ç”¨æç¤º">
                        ğŸ’¡ æç¤º
                        <span class="tool-count" id="hint-count">3</span>
                    </button>
                    <button class="tool-btn" id="time-btn" onclick="useTimeExtension()" title="å»¶é•¿æ—¶é—´">
                        â° åŠ æ—¶
                        <span class="tool-count" id="time-count">1</span>
                    </button>
                    <button class="tool-btn" id="life-btn" onclick="useExtraLife()" title="é¢å¤–ç”Ÿå‘½">
                        â¤ï¸ åŠ å‘½
                        <span class="tool-count" id="life-count">2</span>
                    </button>
                </div>
            </section>

            <!-- æŒ‘æˆ˜ç»“æœé˜¶æ®µ -->
            <section id="challenge-result" class="challenge-result" style="display: none;">
                <div class="result-content">
                    <div class="result-stars" id="result-stars">
                        <!-- æ˜Ÿçº§è¯„ä»·å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div class="result-stats">
                        <h3 id="result-title">æŒ‘æˆ˜å®Œæˆï¼</h3>
                        <div class="score-breakdown">
                            <div class="stat-item">
                                <span class="stat-label">æœ€ç»ˆå¾—åˆ†</span>
                                <span class="stat-value" id="final-score">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">æ­£ç¡®ç‡</span>
                                <span class="stat-value" id="accuracy-rate">0%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ç”¨æ—¶</span>
                                <span class="stat-value" id="time-used">0ç§’</span>
                            </div>
                        </div>
                    </div>

                    <div class="word-review" id="word-review">
                        <h4>å•è¯å­¦ä¹ æ€»ç»“</h4>
                        <div class="review-list" id="review-list">
                            <!-- å•è¯å¤ä¹ åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div class="result-actions">
                        <button class="secondary-btn" onclick="retryChallenge()">é‡æ–°æŒ‘æˆ˜</button>
                        <button class="primary-btn" onclick="continueAdventure()">ç»§ç»­å†’é™©</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- éŸ³é¢‘å½•åˆ¶æŒ‡ç¤ºå™¨ -->
    <div id="recording-indicator" class="recording-indicator" style="display: none;">
        <div class="recording-pulse"></div>
        <span>æ­£åœ¨å½•éŸ³...</span>
    </div>

    <!-- é“å…·ä½¿ç”¨ç¡®è®¤ -->
    <div id="item-use-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>ç¡®è®¤ä½¿ç”¨é“å…·</h3>
            <div class="item-info" id="item-info">
                <!-- é“å…·ä¿¡æ¯å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="modal-actions">
                <button class="secondary-btn" onclick="cancelItemUse()">å–æ¶ˆ</button>
                <button class="primary-btn" id="confirm-item-use">ä½¿ç”¨</button>
            </div>
        </div>
    </div>

    <script>
        // æŒ‘æˆ˜çŠ¶æ€ç®¡ç†
        class ChallengeManager {
            constructor() {
                this.currentChallenge = null;
                this.currentWordIndex = 0;
                this.words = [];
                this.score = 0;
                this.lives = 3;
                this.timeLeft = 60;
                this.timer = null;
                this.isRecording = false;
                this.challengeType = null;
                this.startTime = null;
                this.correctAnswers = 0;
                this.totalAnswers = 0;
            }

            // åˆå§‹åŒ–æŒ‘æˆ˜
            async initChallenge(levelId) {
                try {
                    // è·å–å…³å¡ä¿¡æ¯
                    const level = this.getLevelInfo(levelId);
                    if (!level) {
                        throw new Error('å…³å¡ä¸å­˜åœ¨');
                    }

                    this.challengeType = level.challenges[0]; // é€‰æ‹©ç¬¬ä¸€ä¸ªæŒ‘æˆ˜ç±»å‹
                    this.words = level.words.map(wordId => WordAdventure.findWord(wordId));
                    this.currentWordIndex = 0;
                    this.score = 0;
                    this.lives = 3;

                    // æ˜¾ç¤ºç¬¬ä¸€ä¸ªå•è¯è¿›è¡Œé¢„ä¹ 
                    await this.showWordPreview();

                } catch (error) {
                    console.error('æŒ‘æˆ˜åˆå§‹åŒ–å¤±è´¥:', error);
                    WordAdventureUI.showToast('æŒ‘æˆ˜åŠ è½½å¤±è´¥', 'error');
                }
            }

            getLevelInfo(levelId) {
                for (const islandId in WordAdventureData.LevelConfig) {
                    const island = WordAdventureData.LevelConfig[islandId];
                    const level = island.levels.find(l => l.id === levelId);
                    if (level) {
                        return { ...level, islandId, island };
                    }
                }
                return null;
            }

            // æ˜¾ç¤ºå•è¯é¢„ä¹ 
            async showWordPreview() {
                const word = this.words[this.currentWordIndex];
                if (!word) return;

                document.getElementById('preview-word').textContent = word.word;
                document.getElementById('preview-phonetic').textContent = word.pronunciation;
                document.getElementById('preview-chinese').textContent = word.chinese;
                document.getElementById('preview-mnemonic').textContent = `è®°å¿†å£è¯€: ${word.mnemonic}`;
                document.getElementById('preview-association').textContent = `è”æƒ³åœºæ™¯: ${word.è”æƒ³}`;

                // æ˜¾ç¤ºå‡†å¤‡é˜¶æ®µ
                document.getElementById('challenge-prep').style.display = 'block';
                document.getElementById('challenge-active').style.display = 'none';
                document.getElementById('challenge-result').style.display = 'none';

                // æ’­æ”¾å‘éŸ³
                setTimeout(() => this.playWordSound(word), 500);
            }

            // å¼€å§‹ç»ƒä¹ 
            startPractice() {
                this.startChallenge();
            }

            // å¼€å§‹æŒ‘æˆ˜
            async startChallenge() {
                const word = this.words[this.currentWordIndex];
                if (!word) {
                    this.completeChallenge();
                    return;
                }

                this.startTime = Date.now();
                
                // åˆ‡æ¢åˆ°æŒ‘æˆ˜ç•Œé¢
                document.getElementById('challenge-prep').style.display = 'none';
                document.getElementById('challenge-active').style.display = 'block';
                document.getElementById('challenge-result').style.display = 'none';

                // æ›´æ–°æŒ‘æˆ˜ç±»å‹æ˜¾ç¤º
                const challengeTypeData = WordAdventureData.ChallengeTypes[this.challengeType];
                document.getElementById('challenge-type').textContent = challengeTypeData.name;
                
                // è®¾ç½®æ—¶é—´
                this.timeLeft = challengeTypeData.duration;
                this.updateTimer();

                // æ ¹æ®æŒ‘æˆ˜ç±»å‹æ¸²æŸ“æŒ‘æˆ˜å†…å®¹
                await this.renderChallengeContent(word);

                // å¼€å§‹è®¡æ—¶
                this.startTimer();
            }

            // æ¸²æŸ“æŒ‘æˆ˜å†…å®¹
            async renderChallengeContent(word) {
                const challengeArea = document.getElementById('challenge-area');
                let content = '';

                switch (this.challengeType) {
                    case 'pronunciation':
                        content = this.renderPronunciationChallenge(word);
                        break;
                    case 'spelling':
                        content = this.renderSpellingChallenge(word);
                        break;
                    case 'matching':
                        content = this.renderMatchingChallenge(word);
                        break;
                    case 'memory':
                        content = this.renderMemoryChallenge(word);
                        break;
                    case 'sentence':
                        content = this.renderSentenceChallenge(word);
                        break;
                    default:
                        content = this.renderDefaultChallenge(word);
                }

                challengeArea.innerHTML = content;

                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                WordAdventureUI.animate(challengeArea, 'fade-in');
            }

            // å‘éŸ³æŒ‘æˆ˜
            renderPronunciationChallenge(word) {
                return `
                    <div class="pronunciation-challenge">
                        <div class="target-word">
                            <h3>è¯·æœ—è¯»è¿™ä¸ªå•è¯</h3>
                            <div class="word-display">${word.word}</div>
                            <div class="word-meaning">${word.chinese}</div>
                        </div>
                        <div class="recording-area">
                            <button class="record-btn" id="record-btn" onclick="challengeManager.toggleRecording()">
                                <span class="record-icon">ğŸ¤</span>
                                <span class="record-text">æŒ‰ä½å½•éŸ³</span>
                            </button>
                            <div class="recording-feedback" id="recording-feedback"></div>
                        </div>
                        <div class="pronunciation-tips">
                            <p>ğŸ’¡ æç¤ºï¼šå‘éŸ³è¦æ¸…æ™°ï¼Œæ³¨æ„é‡éŸ³ä½ç½®</p>
                            <p>${word.pronunciation}</p>
                        </div>
                    </div>
                `;
            }

            // æ‹¼å†™æŒ‘æˆ˜
            renderSpellingChallenge(word) {
                return `
                    <div class="spelling-challenge">
                        <div class="target-word">
                            <h3>æ‹¼å†™è¿™ä¸ªå•è¯</h3>
                            <div class="word-meaning">${word.chinese}</div>
                            <div class="word-hint">${word.pronunciation}</div>
                        </div>
                        <div class="spelling-input-area">
                            <input type="text" 
                                   id="spelling-input" 
                                   class="spelling-input" 
                                   placeholder="è¯·è¾“å…¥å•è¯æ‹¼å†™"
                                   onkeyup="challengeManager.checkSpelling(event)">
                            <button class="submit-btn" onclick="challengeManager.submitSpelling()">æäº¤</button>
                        </div>
                        <div class="spelling-feedback" id="spelling-feedback"></div>
                    </div>
                `;
            }

            // åŒ¹é…æŒ‘æˆ˜
            renderMatchingChallenge(word) {
                const options = this.generateMatchingOptions(word);
                return `
                    <div class="matching-challenge">
                        <div class="target-word">
                            <h3>é€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡æ„æ€</h3>
                            <div class="word-display">${word.word}</div>
                        </div>
                        <div class="matching-options">
                            ${options.map((option, index) => `
                                <button class="option-btn" onclick="challengeManager.selectMatchingOption('${option.word}', '${word.chinese}')">
                                    ${option.chinese}
                                </button>
                            `).join('')}
                        </div>
                        <div class="matching-feedback" id="matching-feedback"></div>
                    </div>
                `;
            }

            // è®°å¿†æŒ‘æˆ˜
            renderMemoryChallenge(word) {
                return `
                    <div class="memory-challenge">
                        <div class="memory-cards" id="memory-cards">
                            <!-- è®°å¿†å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                `;
            }

            // å¥å­æŒ‘æˆ˜
            renderSentenceChallenge(word) {
                return `
                    <div class="sentence-challenge">
                        <div class="target-word">
                            <h3>ç”¨è¿™ä¸ªå•è¯é€ å¥</h3>
                            <div class="word-display">${word.word} - ${word.chinese}</div>
                        </div>
                        <div class="sentence-input-area">
                            <textarea id="sentence-input" 
                                     class="sentence-input" 
                                     placeholder="è¯·è¾“å…¥ä¸€ä¸ªå¥å­..."
                                     rows="3"></textarea>
                            <button class="submit-btn" onclick="challengeManager.submitSentence()">æäº¤å¥å­</button>
                        </div>
                        <div class="sentence-feedback" id="sentence-feedback"></div>
                    </div>
                `;
            }

            // é»˜è®¤æŒ‘æˆ˜
            renderDefaultChallenge(word) {
                return `
                    <div class="default-challenge">
                        <div class="target-word">
                            <h3>å­¦ä¹ è¿™ä¸ªå•è¯</h3>
                            <div class="word-display">${word.word}</div>
                            <div class="word-meaning">${word.chinese}</div>
                            <div class="word-mnemonic">${word.mnemonic}</div>
                        </div>
                        <div class="default-actions">
                            <button class="primary-btn" onclick="challengeManager.markAsLearned()">æ ‡è®°ä¸ºå·²å­¦ä¼š</button>
                        </div>
                    </div>
                `;
            }

            // å½•éŸ³æ§åˆ¶
            toggleRecording() {
                const btn = document.getElementById('record-btn');
                const feedback = document.getElementById('recording-feedback');
                const indicator = document.getElementById('recording-indicator');

                if (this.isRecording) {
                    // åœæ­¢å½•éŸ³
                    this.stopRecording();
                    btn.classList.remove('recording');
                    btn.querySelector('.record-text').textContent = 'æŒ‰ä½å½•éŸ³';
                    indicator.style.display = 'none';
                } else {
                    // å¼€å§‹å½•éŸ³
                    this.startRecording();
                    btn.classList.add('recording');
                    btn.querySelector('.record-text').textContent = 'å½•éŸ³ä¸­...';
                    indicator.style.display = 'flex';
                    feedback.textContent = 'è¯·æ¸…æ™°åœ°è¯»å‡ºå•è¯';
                }
            }

            async startRecording() {
                this.isRecording = true;
                
                try {
                    // è¿™é‡Œåº”è¯¥å¯åŠ¨å®é™…çš„å½•éŸ³
                    // const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // æ¨¡æ‹Ÿå½•éŸ³è¿‡ç¨‹
                    setTimeout(() => {
                        if (this.isRecording) {
                            this.stopRecording();
                            this.evaluatePronunciation();
                        }
                    }, 3000);
                    
                } catch (error) {
                    console.error('å½•éŸ³å¤±è´¥:', error);
                    this.isRecording = false;
                    WordAdventureUI.showToast('æ— æ³•è®¿é—®éº¦å…‹é£', 'error');
                }
            }

            stopRecording() {
                this.isRecording = false;
                // åœæ­¢å½•éŸ³æµ
            }

            evaluatePronunciation() {
                const word = this.words[this.currentWordIndex];
                const feedback = document.getElementById('recording-feedback');
                
                // æ¨¡æ‹Ÿå‘éŸ³è¯„åˆ†
                const score = Math.random() * 40 + 60; // 60-100åˆ†
                
                if (score >= 80) {
                    feedback.textContent = `å‘éŸ³å¾ˆå¥½ï¼å¾—åˆ†: ${score.toFixed(1)}`;
                    feedback.className = 'recording-feedback success';
                    this.handleCorrectAnswer();
                } else {
                    feedback.textContent = `ç»§ç»­åŠªåŠ›ï¼å¾—åˆ†: ${score.toFixed(1)}`;
                    feedback.className = 'recording-feedback error';
                    this.handleWrongAnswer();
                }
            }

            // æ‹¼å†™æ£€æŸ¥
            checkSpelling(event) {
                if (event.key === 'Enter') {
                    this.submitSpelling();
                }
            }

            submitSpelling() {
                const input = document.getElementById('spelling-input');
                const feedback = document.getElementById('spelling-feedback');
                const word = this.words[this.currentWordIndex];
                
                const userSpelling = input.value.trim().toLowerCase();
                const correctSpelling = word.word.toLowerCase();
                
                if (userSpelling === correctSpelling) {
                    feedback.textContent = 'æ‹¼å†™æ­£ç¡®ï¼';
                    feedback.className = 'spelling-feedback success';
                    this.handleCorrectAnswer();
                } else {
                    feedback.textContent = `æ‹¼å†™é”™è¯¯ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯: ${word.word}`;
                    feedback.className = 'spelling-feedback error';
                    this.handleWrongAnswer();
                }
            }

            // åŒ¹é…é€‰é¡¹
            generateMatchingOptions(correctWord) {
                const options = [correctWord];
                
                // æ·»åŠ å¹²æ‰°é¡¹
                while (options.length < 4) {
                    const randomIndex = Math.floor(Math.random() * WordAdventureData.WordDatabase.beginner.length);
                    const randomWord = WordAdventureData.WordDatabase.beginner[randomIndex];
                    
                    if (!options.find(opt => opt.id === randomWord.id)) {
                        options.push(randomWord);
                    }
                }
                
                // éšæœºæ’åº
                return options.sort(() => Math.random() - 0.5);
            }

            selectMatchingOption(selectedChinese, correctChinese) {
                const feedback = document.getElementById('matching-feedback');
                
                if (selectedChinese === correctChinese) {
                    feedback.textContent = 'å›ç­”æ­£ç¡®ï¼';
                    feedback.className = 'matching-feedback success';
                    this.handleCorrectAnswer();
                } else {
                    feedback.textContent = `å›ç­”é”™è¯¯ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯: ${correctChinese}`;
                    feedback.className = 'matching-feedback error';
                    this.handleWrongAnswer();
                }
            }

            // å¥å­æäº¤
            submitSentence() {
                const input = document.getElementById('sentence-input');
                const feedback = document.getElementById('sentence-feedback');
                const sentence = input.value.trim();
                
                if (!sentence) {
                    feedback.textContent = 'è¯·è¾“å…¥ä¸€ä¸ªå¥å­';
                    feedback.className = 'sentence-feedback error';
                    return;
                }
                
                // ç®€å•çš„å¥å­è¯„ä¼°
                const word = this.words[this.currentWordIndex];
                const containsWord = sentence.toLowerCase().includes(word.word.toLowerCase());
                
                if (containsWord) {
                    feedback.textContent = 'å¥å­åŒ…å«äº†ç›®æ ‡å•è¯ï¼Œå¾ˆå¥½ï¼';
                    feedback.className = 'sentence-feedback success';
                    this.handleCorrectAnswer();
                } else {
                    feedback.textContent = `å¥å­ä¸­æ²¡æœ‰åŒ…å«å•è¯: ${word.word}`;
                    feedback.className = 'sentence-feedback error';
                    this.handleWrongAnswer();
                }
            }

            // æ ‡è®°ä¸ºå·²å­¦ä¼š
            markAsLearned() {
                const word = this.words[this.currentWordIndex];
                this.handleCorrectAnswer();
            }

            // å¤„ç†æ­£ç¡®ç­”æ¡ˆ
            handleCorrectAnswer() {
                this.correctAnswers++;
                this.totalAnswers++;
                
                // åŠ åˆ†
                const points = 100;
                this.score += points;
                this.updateScore();
                
                // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                WordAdventureUI.playSound('success');
                
                // æ˜¾ç¤ºæˆåŠŸåŠ¨ç”»
                WordAdventureUI.showToast(`+${points}åˆ†ï¼`, 'success');
                
                // å­¦ä¹ å•è¯
                const word = this.words[this.currentWordIndex];
                WordAdventure.learnWord(word.id, 100);
                
                // å»¶è¿Ÿåè¿›å…¥ä¸‹ä¸€ä¸ªå•è¯
                setTimeout(() => {
                    this.nextWord();
                }, 1500);
            }

            // å¤„ç†é”™è¯¯ç­”æ¡ˆ
            handleWrongAnswer() {
                this.totalAnswers++;
                this.lives--;
                
                // æ’­æ”¾é”™è¯¯éŸ³æ•ˆ
                WordAdventureUI.playSound('error');
                
                // æ›´æ–°ç”Ÿå‘½æ˜¾ç¤º
                this.updateLives();
                
                if (this.lives <= 0) {
                    this.endChallenge(false);
                } else {
                    WordAdventureUI.showToast(`ç­”é”™äº†ï¼å‰©ä½™ç”Ÿå‘½: ${this.lives}`, 'error');
                }
            }

            // ä¸‹ä¸€ä¸ªå•è¯
            nextWord() {
                this.currentWordIndex++;
                
                if (this.currentWordIndex >= this.words.length) {
                    this.completeChallenge();
                } else {
                    this.showWordPreview();
                }
            }

            // å®ŒæˆæŒ‘æˆ˜
            completeChallenge() {
                this.endChallenge(true);
            }

            // ç»“æŸæŒ‘æˆ˜
            endChallenge(success) {
                // åœæ­¢è®¡æ—¶å™¨
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }

                // è®¡ç®—ç»Ÿè®¡æ•°æ®
                const timeUsed = Math.floor((Date.now() - this.startTime) / 1000);
                const accuracy = this.totalAnswers > 0 ? Math.round((this.correctAnswers / this.totalAnswers) * 100) : 0;
                const stars = this.calculateStars(accuracy, success);

                // æ˜¾ç¤ºç»“æœ
                this.showChallengeResult(stars, timeUsed, accuracy, success);

                // ä¿å­˜æŒ‘æˆ˜è®°å½•
                this.saveChallengeRecord(success, timeUsed, accuracy);
            }

            // è®¡ç®—æ˜Ÿçº§
            calculateStars(accuracy, success) {
                if (!success) return 0;
                if (accuracy >= 90) return 3;
                if (accuracy >= 75) return 2;
                if (accuracy >= 60) return 1;
                return 1;
            }

            // æ˜¾ç¤ºæŒ‘æˆ˜ç»“æœ
            showChallengeResult(stars, timeUsed, accuracy, success) {
                // åˆ‡æ¢åˆ°ç»“æœç•Œé¢
                document.getElementById('challenge-prep').style.display = 'none';
                document.getElementById('challenge-active').style.display = 'none';
                document.getElementById('challenge-result').style.display = 'block';

                // æ›´æ–°ç»“æœæ ‡é¢˜
                const title = document.getElementById('result-title');
                title.textContent = success ? 'æŒ‘æˆ˜å®Œæˆï¼' : 'æŒ‘æˆ˜å¤±è´¥ï¼';

                // æ˜¾ç¤ºæ˜Ÿçº§
                const starsDiv = document.getElementById('result-stars');
                starsDiv.innerHTML = this.generateStarsHTML(stars);

                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                document.getElementById('final-score').textContent = this.score;
                document.getElementById('accuracy-rate').textContent = `${accuracy}%`;
                document.getElementById('time-used').textContent = `${timeUsed}ç§’`;

                // ç”Ÿæˆå•è¯å¤ä¹ åˆ—è¡¨
                this.generateWordReview();
            }

            generateStarsHTML(stars) {
                let html = '';
                for (let i = 1; i <= 3; i++) {
                    html += `<span class="star ${i <= stars ? 'filled' : 'empty'}">â­</span>`;
                }
                return html;
            }

            generateWordReview() {
                const reviewList = document.getElementById('review-list');
                let html = '';

                this.words.forEach((word, index) => {
                    const isLearned = index < this.correctAnswers;
                    html += `
                        <div class="review-item ${isLearned ? 'learned' : 'not-learned'}">
                            <div class="review-word">${word.word}</div>
                            <div class="review-meaning">${word.chinese}</div>
                            <div class="review-status">${isLearned ? 'âœ… å·²å­¦ä¼š' : 'âŒ éœ€è¦å¤ä¹ '}</div>
                        </div>
                    `;
                });

                reviewList.innerHTML = html;
            }

            // ä¿å­˜æŒ‘æˆ˜è®°å½•
            saveChallengeRecord(success, timeUsed, accuracy) {
                const record = {
                    challengeType: this.challengeType,
                    wordsCount: this.words.length,
                    correctAnswers: this.correctAnswers,
                    totalAnswers: this.totalAnswers,
                    score: this.score,
                    timeUsed: timeUsed,
                    accuracy: accuracy,
                    success: success,
                    timestamp: Date.now()
                };

                WordAdventure.gameState.learning.challengeHistory.push(record);

                // å®Œæˆå…³å¡
                if (success) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const levelId = urlParams.get('level');
                    if (levelId) {
                        WordAdventure.completeLevel(levelId, this.score, this.calculateStars(accuracy, true));
                    }
                }
            }

            // è®¡æ—¶å™¨ç®¡ç†
            startTimer() {
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    this.updateTimer();

                    if (this.timeLeft <= 0) {
                        this.endChallenge(false);
                    }
                }, 1000);
            }

            updateTimer() {
                const timerDisplay = document.getElementById('timer-display');
                const timerFill = document.getElementById('timer-fill');
                
                timerDisplay.textContent = `â±ï¸ ${this.timeLeft}`;
                
                const totalTime = WordAdventureData.ChallengeTypes[this.challengeType].duration;
                const percentage = (this.timeLeft / totalTime) * 100;
                timerFill.style.width = `${percentage}%`;

                // æ—¶é—´ä¸è¶³æ—¶å˜çº¢
                if (this.timeLeft <= 10) {
                    timerDisplay.classList.add('warning');
                }
            }

            // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
            updateScore() {
                document.getElementById('current-score').textContent = this.score;
            }

            // æ›´æ–°ç”Ÿå‘½æ˜¾ç¤º
            updateLives() {
                const livesDisplay = document.getElementById('current-lives');
                livesDisplay.textContent = 'â¤ï¸'.repeat(Math.max(0, this.lives));
                
                if (this.lives <= 1) {
                    livesDisplay.classList.add('warning');
                }
            }

            // æ’­æ”¾å•è¯å‘éŸ³
            playWordSound(word) {
                // è¿™é‡Œåº”è¯¥ä½¿ç”¨ TTS æ’­æ”¾å•è¯å‘éŸ³
                // æš‚æ—¶ä½¿ç”¨å ä½ç¬¦
                console.log(`æ’­æ”¾å‘éŸ³: ${word.word}`);
                WordAdventureUI.playSound('click');
            }

            // é‡æ–°æŒ‘æˆ˜
            retry() {
                this.currentWordIndex = 0;
                this.score = 0;
                this.lives = 3;
                this.correctAnswers = 0;
                this.totalAnswers = 0;
                
                this.showWordPreview();
            }

            // ç»§ç»­å†’é™©
            continueAdventure() {
                if (window.parent && window.parent.NavigationManager) {
                    window.parent.NavigationManager.navigateToPage('adventure-home.html');
                }
            }
        }

        // å…¨å±€æŒ‘æˆ˜ç®¡ç†å™¨å®ä¾‹
        let challengeManager;

        // ===== é¡µé¢åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('åˆå§‹åŒ–æŒ‘æˆ˜é¡µé¢...');
            
            try {
                initializeChallenge();
                loadSampleWord();
                updateToolCounts();
                
                console.log('æŒ‘æˆ˜é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('æŒ‘æˆ˜é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });
        
        function initializeChallenge() {
            // è·å–URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const levelId = urlParams.get('level') || 'demo';
            
            if (levelId) {
                document.getElementById('challenge-title').textContent = `å•è¯æŒ‘æˆ˜ - ${levelId}`;
            }
        }
        
        function loadSampleWord() {
            // ä»æ•°æ®åº“åŠ è½½éšæœºå•è¯
            const allWords = [
                ...IslandWords.creature_island.words,
                ...IslandWords.volcano_island.words
            ];
            
            const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
            
            // æ›´æ–°å•è¯æ˜¾ç¤º
            document.getElementById('preview-word').textContent = randomWord.word;
            document.getElementById('preview-phonetic').textContent = randomWord.phonetic;
            document.getElementById('preview-chinese').textContent = randomWord.chinese;
            document.getElementById('preview-mnemonic').textContent = `è®°å¿†å£è¯€ï¼š${randomWord.mnemonic}`;
            document.getElementById('preview-association').textContent = `è”æƒ³åœºæ™¯ï¼š${randomWord.association}`;
        }

        // ===== æŒ‘æˆ˜åŠŸèƒ½å‡½æ•° =====
        function goBack() {
            if (window.parent && window.parent.NavigationManager) {
                window.parent.NavigationManager.navigateToPage('adventure-home.html');
            } else {
                history.back();
            }
        }

        function playWordPronunciation() {
            if (challengeManager && challengeManager.words[challengeManager.currentWordIndex]) {
                const word = challengeManager.words[challengeManager.currentWordIndex];
                challengeManager.playWordSound(word);
            }
        }

        function startPractice() {
            if (challengeManager) {
                challengeManager.startChallenge();
            }
        }

        function useHint() {
            const count = parseInt(document.getElementById('hint-count').textContent);
            if (count > 0) {
                document.getElementById('hint-count').textContent = count - 1;
                
                // å®ç°æç¤ºé€»è¾‘
                const currentWord = challengeManager.words[challengeManager.currentWordIndex];
                WordAdventureUI.showToast(`æç¤º: ${currentWord.mnemonic}`, 'info');
                
                WordAdventureUI.playSound('click');
            } else {
                WordAdventureUI.showToast('æç¤ºå·²ç”¨å®Œ', 'warning');
            }
        }

        function useTimeExtension() {
            const count = parseInt(document.getElementById('time-count').textContent);
            if (count > 0) {
                document.getElementById('time-count').textContent = count - 1;
                
                // å»¶é•¿æ—¶é—´
                challengeManager.timeLeft += 30;
                challengeManager.updateTimer();
                
                WordAdventureUI.showToast('æ—¶é—´å¢åŠ äº†30ç§’ï¼', 'success');
                WordAdventureUI.playSound('success');
            } else {
                WordAdventureUI.showToast('åŠ æ—¶é“å…·å·²ç”¨å®Œ', 'warning');
            }
        }

        function useExtraLife() {
            const count = parseInt(document.getElementById('life-count').textContent);
            if (count > 0 && challengeManager.lives < 3) {
                document.getElementById('life-count').textContent = count - 1;
                
                // å¢åŠ ç”Ÿå‘½
                challengeManager.lives++;
                challengeManager.updateLives();
                
                WordAdventureUI.showToast('ç”Ÿå‘½å€¼æ¢å¤äº†ï¼', 'success');
                WordAdventureUI.playSound('success');
            } else {
                WordAdventureUI.showToast('æ— æ³•ä½¿ç”¨é¢å¤–ç”Ÿå‘½', 'warning');
            }
        }

        function updateToolCounts() {
            // ç®€åŒ–çš„é“å…·æ•°é‡
            document.getElementById('hint-count').textContent = '3';
            document.getElementById('time-count').textContent = '1';
            document.getElementById('life-count').textContent = '2';
        }
        
        function playWordPronunciation() {
            console.log('æ’­æ”¾å•è¯å‘éŸ³');
            showFloatingText('å‘éŸ³åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
        
        function startPractice() {
            console.log('å¼€å§‹ç»ƒä¹ ');
            showFloatingText('ç»ƒä¹ æ¨¡å¼å¼€å‘ä¸­...', 'info');
            
            // æ˜¾ç¤ºæŒ‘æˆ˜åŒºåŸŸ
            document.getElementById('challenge-prep').style.display = 'none';
            document.getElementById('challenge-active').style.display = 'block';
            
            // è®¾ç½®æŒ‘æˆ˜ç±»å‹
            document.getElementById('challenge-type').textContent = 'å•è¯å‘éŸ³ç»ƒä¹ ';
            startTimer();
        }
        
        function startTimer() {
            let timeLeft = 60;
            const timerDisplay = document.getElementById('timer-display');
            const timerFill = document.getElementById('timer-fill');
            
            const timer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `â±ï¸ ${timeLeft}`;
                
                if (timerFill) {
                    const percentage = (timeLeft / 60) * 100;
                    timerFill.style.width = `${percentage}%`;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    endChallenge();
                }
            }, 1000);
        }
        
        function useHint() {
            console.log('ä½¿ç”¨æç¤º');
            showFloatingText('ä½¿ç”¨äº†ä¸€ä¸ªæç¤ºï¼', 'hint');
        }
        
        function useTimeExtension() {
            console.log('å»¶é•¿æ—¶é—´');
            showFloatingText('æ—¶é—´å¢åŠ äº†30ç§’ï¼', 'time');
        }
        
        function useExtraLife() {
            console.log('ä½¿ç”¨é¢å¤–ç”Ÿå‘½');
            showFloatingText('ç”Ÿå‘½å€¼+1ï¼', 'life');
        }
        
        function endChallenge() {
            document.getElementById('challenge-active').style.display = 'none';
            document.getElementById('challenge-result').style.display = 'block';
            
            // æ˜¾ç¤ºç»“æœ
            showChallengeResult();
        }
        
        function showChallengeResult() {
            const resultStars = document.getElementById('result-stars');
            resultStars.innerHTML = 'â­â­â­'; // 3æ˜Ÿè¯„ä»·
            
            document.getElementById('result-title').textContent = 'æŒ‘æˆ˜å®Œæˆï¼';
            document.getElementById('final-score').textContent = '85';
            document.getElementById('accuracy-rate').textContent = '85%';
        }
        
        function goBack() {
            window.location.href = 'challenges.html';
        }
        
        function showFloatingText(text, type) {
            const floatingText = document.createElement('div');
            floatingText.className = `floating-text floating-${type}`;
            floatingText.textContent = text;
            
            floatingText.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                z-index: 1000;
                font-size: 16px;
                animation: fadeInOut 2s ease-in-out;
            `;
            
            document.body.appendChild(floatingText);
            
            setTimeout(() => {
                if (floatingText.parentNode) {
                    floatingText.parentNode.removeChild(floatingText);
                }
            }, 2000);
        }

        function retryChallenge() {
            if (challengeManager) {
                challengeManager.retry();
            }
        }

        function continueAdventure() {
            if (challengeManager) {
                challengeManager.continueAdventure();
            }
        }

        // ç›‘å¬é¡µé¢å¸è½½ï¼Œä¿å­˜è¿›åº¦
        window.addEventListener('beforeunload', function() {
            if (typeof WordAdventure !== 'undefined') {
                WordAdventure.saveGame();
            }
        });
    </script>

    <style>
        /* æŒ‘æˆ˜é¡µé¢ä¸“å±æ ·å¼ */
        .challenge-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
        }

        .challenge-info {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .score-display {
            font-weight: bold;
        }

        .lives-display.warning {
            color: #ff6b6b;
        }

        /* æŒ‘æˆ˜å‡†å¤‡é˜¶æ®µ */
        .challenge-preparation {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .word-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .word-main {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .word-phonetic {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .word-chinese {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 12px;
        }

        .word-mnemonic, .word-association {
            font-size: 14px;
            color: #666;
            margin: 8px 0;
            padding: 8px;
            background: rgba(106, 17, 203, 0.1);
            border-radius: 6px;
        }

        .prep-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        /* æŒ‘æˆ˜è¿›è¡Œé˜¶æ®µ */
        .challenge-active {
            padding: 16px;
        }

        .challenge-header {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .challenge-type {
            font-size: 18px;
            font-weight: bold;
            color: #6A11CB;
        }

        .challenge-timer {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #timer-display {
            font-weight: bold;
            color: #333;
        }

        #timer-display.warning {
            color: #ff6b6b;
        }

        .timer-bar {
            width: 100px;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
        }

        .timer-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 1s linear;
        }

        /* æŒ‘æˆ˜åŒºåŸŸ */
        .challenge-area {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            min-height: 300px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* å‘éŸ³æŒ‘æˆ˜ */
        .pronunciation-challenge {
            text-align: center;
        }

        .target-word h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .word-display {
            font-size: 36px;
            font-weight: bold;
            color: #6A11CB;
            margin-bottom: 10px;
        }

        .word-meaning {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }

        .record-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #6A11CB;
            background: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0 auto 20px;
            transition: all 0.2s ease;
        }

        .record-btn:hover {
            transform: scale(1.05);
        }

        .record-btn.recording {
            background: #ff6b6b;
            border-color: #ff6b6b;
            color: white;
            animation: pulse 1s infinite;
        }

        .record-icon {
            font-size: 32px;
        }

        .recording-feedback {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .recording-feedback.success {
            color: #4CAF50;
        }

        .recording-feedback.error {
            color: #f44336;
        }

        /* æ‹¼å†™æŒ‘æˆ˜ */
        .spelling-challenge {
            text-align: center;
        }

        .word-hint {
            font-size: 16px;
            color: #888;
            margin-bottom: 30px;
        }

        .spelling-input-area {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .spelling-input {
            font-size: 18px;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            width: 250px;
            text-align: center;
        }

        .spelling-input:focus {
            border-color: #6A11CB;
            outline: none;
        }

        .spelling-feedback {
            font-size: 14px;
            margin-top: 10px;
        }

        .spelling-feedback.success {
            color: #4CAF50;
        }

        .spelling-feedback.error {
            color: #f44336;
        }

        /* åŒ¹é…æŒ‘æˆ˜ */
        .matching-challenge {
            text-align: center;
        }

        .matching-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-btn {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .option-btn:hover {
            border-color: #6A11CB;
            transform: translateY(-2px);
        }

        .matching-feedback {
            font-size: 14px;
        }

        .matching-feedback.success {
            color: #4CAF50;
        }

        .matching-feedback.error {
            color: #f44336;
        }

        /* å¥å­æŒ‘æˆ˜ */
        .sentence-challenge {
            text-align: center;
        }

        .sentence-input-area {
            margin-bottom: 20px;
        }

        .sentence-input {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
        }

        .sentence-input:focus {
            border-color: #6A11CB;
            outline: none;
        }

        .sentence-feedback {
            font-size: 14px;
        }

        .sentence-feedback.success {
            color: #4CAF50;
        }

        .sentence-feedback.error {
            color: #f44336;
        }

        /* æŒ‘æˆ˜å·¥å…· */
        .challenge-tools {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .tool-btn {
            position: relative;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .tool-btn:hover {
            border-color: #6A11CB;
            transform: translateY(-2px);
        }

        .tool-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #6A11CB;
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 8px;
            min-width: 16px;
            text-align: center;
        }

        /* æŒ‘æˆ˜ç»“æœ */
        .challenge-result {
            padding: 16px;
        }

        .result-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .result-stars {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .star.filled {
            color: #FFD700;
        }

        .star.empty {
            color: #e9ecef;
        }

        .result-stats h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .score-breakdown {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            display: block;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #6A11CB;
        }

        .word-review {
            text-align: left;
            margin: 20px 0;
        }

        .word-review h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .review-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .review-item.learned {
            background: linear-gradient(135deg, #e8f5e8, #f0fff0);
            border-color: #4CAF50;
        }

        .review-item.not-learned {
            background: linear-gradient(135deg, #ffeaea, #fff5f5);
            border-color: #f44336;
        }

        .review-word {
            font-weight: bold;
            color: #333;
        }

        .review-meaning {
            color: #666;
            margin: 0 10px;
        }

        .review-status {
            font-size: 12px;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        /* å½•éŸ³æŒ‡ç¤ºå™¨ */
        .recording-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        .recording-pulse {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            animation: recordingPulse 1s infinite;
        }

        @keyframes recordingPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 375px) {
            .challenge-info {
                font-size: 12px;
                gap: 10px;
            }

            .word-main {
                font-size: 28px;
            }

            .word-display {
                font-size: 28px;
            }

            .matching-options {
                grid-template-columns: 1fr;
            }

            .score-breakdown {
                flex-direction: column;
                gap: 10px;
            }

            .review-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</body>
</html>