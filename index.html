<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯å†’é™©å²› - é­”æ³•è‹±è¯­å­¦ä¹ ä¸–ç•Œ</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/ios-status-bar.css">
    <link rel="stylesheet" href="css/word-adventure.css">
    <link rel="icon" href="assets/images/icon.png" type="image/png">
</head>
<body>
    <!-- iOSçŠ¶æ€æ æ¨¡æ‹Ÿ -->
    <div class="ios-status-bar">
        <div class="status-left">9:41</div>
        <div class="status-center">
            <span class="signal"></span>
            <span class="wifi"></span>
            <span class="battery">100%</span>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="app-container word-adventure-app">
        <!-- æ¸¸æˆä¸»ç•Œé¢ -->
        <div id="game-container">
            <!-- æ¸¸æˆç•Œé¢å®¹å™¨ -->
            <iframe id="page-frame" src="adventure-home.html" frameborder="0"></iframe>
            
            <!-- åº•éƒ¨å¯¼èˆªæ  -->
            <nav class="bottom-nav adventure-nav">
                <a href="adventure-home.html" class="nav-item active" data-page="adventure-home">
                    <div class="nav-icon">ğŸï¸</div>
                    <span>å†’é™©</span>
                </a>
                <a href="word-book.html" class="nav-item" data-page="word-book">
                    <div class="nav-icon">ğŸ“–</div>
                    <span>å•è¯</span>
                </a>
                <a href="challenges.html" class="nav-item" data-page="challenges">
                    <div class="nav-icon">ğŸ®</div>
                    <span>æŒ‘æˆ˜</span>
                </a>
                <a href="profile.html" class="nav-item" data-page="profile">
                    <div class="nav-icon">ğŸ‘¤</div>
                    <span>æˆ‘çš„</span>
                </a>
            </nav>
        </div>

        <!-- ç©å®¶çŠ¶æ€æ  -->
        <div class="player-status-bar">
            <div class="player-info">
                <div class="player-avatar">
                    <img src="assets/images/avatars/feifei.png" alt="éœéœ" id="player-avatar">
                    <div class="level-badge" id="player-level">Lv.1</div>
                </div>
                <div class="player-stats">
                    <div class="exp-bar">
                        <div class="exp-fill" id="exp-fill"></div>
                        <span class="exp-text" id="exp-text">0/100</span>
                    </div>
                    <div class="coins-display">
                        <span class="coins-icon">ğŸ’°</span>
                        <span id="coins-amount">100</span>
                    </div>
                </div>
            </div>
            <div class="quick-actions">
                <button class="quick-btn" id="daily-quest-btn" title="æ¯æ—¥ä»»åŠ¡">
                    ğŸ“‹
                    <span class="badge" id="daily-quest-badge" style="display:none;">!</span>
                </button>
                <button class="quick-btn" id="settings-btn" title="è®¾ç½®">
                    âš™ï¸
                </button>
            </div>
        </div>

        <!-- è¿ç»­å­¦ä¹ æç¤º -->
        <div class="streak-notification" id="streak-notification" style="display:none;">
            <div class="streak-content">
                <span class="streak-icon">ğŸ”¥</span>
                <span class="streak-text">å·²è¿ç»­å­¦ä¹  <span id="streak-days">1</span> å¤©ï¼</span>
                <button class="streak-close" onclick="hideStreakNotification()">Ã—</button>
            </div>
        </div>
    </div>

    <!-- å…¨å±€åŠ è½½æç¤º -->
    <div id="global-loading" class="loading-overlay game-loading" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner magic-spinner"></div>
            <p>æ­£åœ¨è¿›å…¥å•è¯å†’é™©å²›...</p>
            <div class="loading-tips">
                <span id="loading-tip">æ¯ä¸ªå•è¯éƒ½æœ‰å®ƒçš„é­”æ³•æ•…äº‹ï¼</span>
            </div>
        </div>
    </div>

    <!-- æˆå°±å¼¹çª— -->
    <div id="achievement-popup" class="achievement-popup" style="display:none;">
        <div class="achievement-content">
            <div class="achievement-icon">ğŸ†</div>
            <h3 class="achievement-title" id="achievement-title">æˆå°±è§£é”ï¼</h3>
            <p class="achievement-desc" id="achievement-desc">æè¿°</p>
            <div class="achievement-reward">
                <span class="reward-exp">+<span id="reward-exp">0</span> EXP</span>
            </div>
            <button class="achievement-close" onclick="closeAchievement()">ç¡®å®š</button>
        </div>
    </div>

    <!-- é“å…·ä½¿ç”¨ç¡®è®¤ -->
    <div id="item-confirm" class="modal-overlay" style="display:none;">
        <div class="modal-content item-modal">
            <h3>ä½¿ç”¨é“å…·</h3>
            <div class="item-preview">
                <div class="item-icon" id="confirm-item-icon">ğŸ“œ</div>
                <div class="item-info">
                    <h4 id="confirm-item-name">æç¤ºå·è½´</h4>
                    <p id="confirm-item-desc">æ˜¾ç¤ºå•è¯çš„ç¬¬ä¸€ä¸ªå­—æ¯</p>
                </div>
            </div>
            <div class="item-count">
                æ‹¥æœ‰æ•°é‡: <span id="confirm-item-count">1</span>
            </div>
            <div class="modal-actions">
                <button class="secondary-btn" onclick="closeItemConfirm()">å–æ¶ˆ</button>
                <button class="primary-btn" onclick="confirmUseItem()">ä½¿ç”¨</button>
            </div>
        </div>
    </div>

    <!-- æ¯æ—¥ä»»åŠ¡å¼¹çª— -->
    <div id="daily-quest-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content quest-modal">
            <div class="quest-header">
                <h3>æ¯æ—¥ä»»åŠ¡</h3>
                <div class="quest-date" id="quest-date">ä»Šå¤©</div>
            </div>
            <div class="quest-list" id="quest-list">
                <!-- ä»»åŠ¡åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="quest-rewards">
                <h4>å®Œæˆå¥–åŠ±</h4>
                <div class="reward-items">
                    <div class="reward-item">
                        <span class="reward-icon">ğŸ’°</span>
                        <span class="reward-value">50</span>
                    </div>
                    <div class="reward-item">
                        <span class="reward-icon">â­</span>
                        <span class="reward-value">100 EXP</span>
                    </div>
                </div>
            </div>
            <button class="primary-btn" onclick="closeDailyQuest()">å…³é—­</button>
        </div>
    </div>

    <!-- JavaScriptæ–‡ä»¶åŠ è½½ -->
    <script src="js/word-adventure-data.js"></script>
    <script src="js/word-adventure-engine.js"></script>
    <script src="js/word-adventure-ui.js"></script>
    <script src="js/main.js"></script>
    <script>
        // ===== å•è¯å†’é™©å²›ä¸»å…¥å£ =====
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('å•è¯å†’é™©å²›å¯åŠ¨ä¸­...');
                
                // æ˜¾ç¤ºåŠ è½½ç•Œé¢
                showGlobalLoading();
                
                // ç®€åŒ–çš„åˆå§‹åŒ–æµç¨‹
                initializeSimpleGame();
                
                // è®¾ç½®åŸºæœ¬äº‹ä»¶ç›‘å¬
                setupBasicEventListeners();
                
                // éšè—åŠ è½½ç•Œé¢
                setTimeout(() => {
                    hideGlobalLoading();
                    showWelcomeMessage();
                }, 1000);
                
                console.log('å•è¯å†’é™©å²›å¯åŠ¨å®Œæˆ');
                
            } catch (error) {
                console.error('æ¸¸æˆå¯åŠ¨å¤±è´¥:', error);
                showErrorAndReload();
            }
        });
        
        // ===== æ¸¸æˆäº‹ä»¶ç›‘å¬ =====
        function setupGameEventListeners() {
            // ç»éªŒå€¼è·å¾—
            WordAdventure.on('experienceGained', function(data) {
                updatePlayerStatusBar();
                showFloatingText(`+${data.amount} EXP`, 'exp');
            });
            
            // é‡‘å¸è·å¾—
            WordAdventure.on('coinsGained', function(data) {
                updatePlayerStatusBar();
                showFloatingText(`+${data.amount} ğŸ’°`, 'coins');
            });
            
            // å‡çº§
            WordAdventure.on('levelUp', function(data) {
                updatePlayerStatusBar();
                showLevelUpEffect(data.newLevel);
            });
            
            // æˆå°±è§£é”
            WordAdventure.on('achievementUnlocked', function(data) {
                showAchievementPopup(data.achievement);
            });
            
            // å•è¯å­¦ä¼š
            WordAdventure.on('wordLearned', function(data) {
                updateDailyQuestProgress('wordsLearned', 1);
            });
            
            // æŒ‘æˆ˜å®Œæˆ
            WordAdventure.on('challengeCompleted', function(data) {
                updateDailyQuestProgress('challengesCompleted', 1);
            });
            
            // å¤ä¹ å•è¯åˆ°æœŸ
            WordAdventure.on('reviewWordsDue', function(data) {
                showReviewReminder(data.words.length);
            });
        }
        
        // ===== ç©å®¶çŠ¶æ€æ æ›´æ–° =====
        function updatePlayerStatusBar() {
            if (!WordAdventure.gameState) return;
            
            const player = WordAdventure.gameState.player;
            
            // æ›´æ–°ç­‰çº§
            document.getElementById('player-level').textContent = `Lv.${player.stats.level}`;
            
            // æ›´æ–°ç»éªŒæ¡
            const currentExp = player.stats.exp;
            const expNeeded = player.stats.level * 100;
            const expPercentage = (currentExp / expNeeded) * 100;
            
            const expFill = document.getElementById('exp-fill');
            expFill.style.width = `${expPercentage}%`;
            
            const expText = document.getElementById('exp-text');
            expText.textContent = `${currentExp}/${expNeeded}`;
            
            // æ›´æ–°é‡‘å¸
            document.getElementById('coins-amount').textContent = player.inventory.coins;
            
            // æ›´æ–°å¤´åƒï¼ˆå¦‚æœæœ‰æˆé•¿ï¼‰
            updatePlayerAvatar();
        }
        
        function updatePlayerAvatar() {
            const growth = WordAdventure.gameState.characterGrowth;
            const avatar = document.getElementById('player-avatar');
            
            if (growth && growth.feifei) {
                // æ ¹æ®æˆé•¿é˜¶æ®µæ›´æ¢å¤´åƒ
                const stage = growth.feifei.currentStage;
                if (stage >= 3) {
                    avatar.src = 'assets/images/avatars/feifei-confident.png';
                }
            }
        }
        
        // ===== æ¯æ—¥ç™»å½•æ£€æŸ¥ =====
        function checkDailyLogin() {
            const lastPlay = WordAdventure.gameState.player.progress.lastPlayDate;
            const today = new Date().toDateString();
            
            if (lastPlay !== today) {
                // æ–°çš„ä¸€å¤©ï¼Œæ˜¾ç¤ºç™»å½•å¥–åŠ±
                setTimeout(() => {
                    showDailyLoginReward();
                }, 2000);
            }
        }
        
        function showDailyLoginReward() {
            const streak = WordAdventure.gameState.player.progress.streak;
            const reward = streak > 1 ? WordAdventure.gameState.player.stats.level * 10 : 5;
            
            showFloatingText(`æ¯æ—¥ç™»å½• +${reward} EXP`, 'daily-bonus');
        }
        
        // ===== å¤ä¹ æé†’ =====
        function checkReviewReminder() {
            const reviewingWords = WordAdventure.gameState.learning.reviewingWords;
            const now = Date.now();
            
            const dueWords = reviewingWords.filter(review => review.reviewDate <= now);
            
            if (dueWords.length > 0) {
                setTimeout(() => {
                    showReviewReminder(dueWords.length);
                }, 3000);
            }
        }
        
        function showReviewReminder(count) {
            showFloatingText(`æœ‰ ${count} ä¸ªå•è¯éœ€è¦å¤ä¹ `, 'reminder');
        }
        
        // ===== è¿ç»­å­¦ä¹ æç¤º =====
        function showStreakNotification(days) {
            const notification = document.getElementById('streak-notification');
            const streakDays = document.getElementById('streak-days');
            
            streakDays.textContent = days;
            notification.style.display = 'block';
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                hideStreakNotification();
            }, 5000);
        }
        
        function hideStreakNotification() {
            document.getElementById('streak-notification').style.display = 'none';
        }
        
        // ===== æˆå°±å¼¹çª— =====
        function showAchievementPopup(achievement) {
            const popup = document.getElementById('achievement-popup');
            const title = document.getElementById('achievement-title');
            const desc = document.getElementById('achievement-desc');
            const rewardExp = document.getElementById('reward-exp');
            
            title.textContent = achievement.name;
            desc.textContent = achievement.description;
            rewardExp.textContent = achievement.expReward || 0;
            
            popup.style.display = 'flex';
            
            // æ’­æ”¾æˆå°±éŸ³æ•ˆ
            if (WordAdventure.gameState.settings.soundEnabled) {
                playAchievementSound();
            }
            
            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                closeAchievement();
            }, 3000);
        }
        
        function closeAchievement() {
            document.getElementById('achievement-popup').style.display = 'none';
        }
        
        // ===== æ¯æ—¥ä»»åŠ¡ =====
        document.getElementById('daily-quest-btn').addEventListener('click', function() {
            showDailyQuestModal();
        });
        
        function showDailyQuestModal() {
            const modal = document.getElementById('daily-quest-modal');
            const questList = document.getElementById('quest-list');
            const questDate = document.getElementById('quest-date');
            
            // æ›´æ–°æ—¥æœŸ
            const today = new Date();
            const options = { month: 'long', day: 'numeric' };
            questDate.textContent = today.toLocaleDateString('zh-CN', options);
            
            // ç”Ÿæˆä»»åŠ¡åˆ—è¡¨
            const quests = generateDailyQuests();
            questList.innerHTML = quests.map(quest => createQuestHTML(quest)).join('');
            
            modal.style.display = 'flex';
            
            // éšè—ä»»åŠ¡å¾½ç« 
            document.getElementById('daily-quest-badge').style.display = 'none';
        }
        
        function generateDailyQuests() {
            const dailyTasks = WordAdventure.gameState.dailyTasks || {
                wordsLearned: 0,
                challengesCompleted: 0,
                reviewCompleted: 0,
                timeSpent: 0
            };
            
            return [
                {
                    icon: 'ğŸ“š',
                    name: 'å­¦ä¹ æ–°å•è¯',
                    current: dailyTasks.wordsLearned,
                    target: 10,
                    reward: '20 EXP'
                },
                {
                    icon: 'ğŸ®',
                    name: 'å®ŒæˆæŒ‘æˆ˜',
                    current: dailyTasks.challengesCompleted,
                    target: 5,
                    reward: '30 EXP'
                },
                {
                    icon: 'ğŸ”„',
                    name: 'å¤ä¹ å•è¯',
                    current: dailyTasks.reviewCompleted,
                    target: 3,
                    reward: '15 EXP'
                },
                {
                    icon: 'â±ï¸',
                    name: 'å­¦ä¹ æ—¶é—´',
                    current: Math.floor(dailyTasks.timeSpent / 60),
                    target: 20,
                    reward: '25 EXP'
                }
            ];
        }
        
        function createQuestHTML(quest) {
            const progress = Math.min(quest.current, quest.target);
            const percentage = (progress / quest.target) * 100;
            const isCompleted = progress >= quest.target;
            
            return `
                <div class="quest-item ${isCompleted ? 'completed' : ''}">
                    <div class="quest-info">
                        <span class="quest-icon">${quest.icon}</span>
                        <div class="quest-details">
                            <div class="quest-name">${quest.name}</div>
                            <div class="quest-progress">${progress}/${quest.target}</div>
                        </div>
                    </div>
                    <div class="quest-status">
                        <div class="quest-bar">
                            <div class="quest-fill" style="width: ${percentage}%"></div>
                        </div>
                        <span class="quest-reward">${quest.reward}</span>
                    </div>
                </div>
            `;
        }
        
        function closeDailyQuest() {
            document.getElementById('daily-quest-modal').style.display = 'none';
        }
        
        function updateDailyQuestProgress(type, amount) {
            if (!WordAdventure.gameState.dailyTasks) {
                WordAdventure.resetDailyTasks();
            }
            
            WordAdventure.gameState.dailyTasks[type] += amount;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»åŠ¡å®Œæˆ
            checkQuestCompletion();
        }
        
        function checkQuestCompletion() {
            const quests = generateDailyQuests();
            const allCompleted = quests.every(quest => quest.current >= quest.target);
            
            if (allCompleted) {
                // æ˜¾ç¤ºä»»åŠ¡å¾½ç« 
                document.getElementById('daily-quest-badge').style.display = 'inline-block';
            }
        }
        
        // ===== ç®€åŒ–çš„æ¸¸æˆåˆå§‹åŒ– =====
        function initializeSimpleGame() {
            // åŠ è½½ä¿å­˜çš„æ¸¸æˆçŠ¶æ€
            loadSimpleGameState();
            
            // æ›´æ–°ç©å®¶çŠ¶æ€æ 
            updatePlayerStatusBar();
        }
        
        function loadSimpleGameState() {
            const savedState = localStorage.getItem('word-adventure-simple-state');
            
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    // ç®€å•çš„çŠ¶æ€æ¢å¤
                    if (state.player) {
                        updatePlayerStats(state.player);
                    }
                } catch (error) {
                    console.log('ä½¿ç”¨é»˜è®¤æ¸¸æˆçŠ¶æ€');
                }
            }
        }
        
        function updatePlayerStats(playerData = null) {
            if (playerData) {
                document.getElementById('player-level').textContent = playerData.level || 1;
                document.getElementById('coins-amount').textContent = playerData.coins || 100;
                
                const exp = playerData.exp || 0;
                const level = playerData.level || 1;
                const expNeeded = level * 100;
                const expPercentage = (exp / expNeeded) * 100;
                
                const expFill = document.getElementById('exp-fill');
                const expText = document.getElementById('exp-text');
                
                if (expFill) {
                    expFill.style.width = `${expPercentage}%`;
                }
                
                if (expText) {
                    expText.textContent = `${exp}/${expNeeded}`;
                }
            }
        }
        
        function setupBasicEventListeners() {
            // å¯¼èˆªé“¾æ¥
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const href = this.getAttribute('href');
                    const pageFrame = document.getElementById('page-frame');
                    if (pageFrame && href) {
                        pageFrame.src = href;
                        
                        // æ›´æ–°å¯¼èˆªçŠ¶æ€
                        document.querySelectorAll('.nav-item').forEach(nav => {
                            nav.classList.remove('active');
                        });
                        this.classList.add('active');
                    }
                });
            });
            
            // è®¾ç½®æŒ‰é’®
            const settingsBtn = document.getElementById('settings-btn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', function() {
                    alert('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...');
                });
            }
        }
        
        function showWelcomeMessage() {
            const messages = [
                'æ¬¢è¿æ¥åˆ°å•è¯å†’é™©å²›ï¼ğŸï¸',
                'å¼€å§‹ä½ çš„è‹±è¯­å­¦ä¹ ä¹‹æ—…ï¼ğŸ“š',
                'æ¯ä¸ªå•è¯éƒ½æœ‰é­”æ³•æ•…äº‹ï¼âœ¨'
            ];
            
            const message = messages[Math.floor(Math.random() * messages.length)];
            showFloatingText(message, 'welcome');
        }
        
        // ===== å·¥å…·å‡½æ•° =====
        function showGlobalLoading() {
            const loading = document.getElementById('global-loading');
            const tip = document.getElementById('loading-tip');
            
            const tips = [
                'æ¯ä¸ªå•è¯éƒ½æœ‰å®ƒçš„é­”æ³•æ•…äº‹ï¼',
                'å‹‡æ•¢çš„å¿ƒèƒ½æˆ˜èƒœä¸€åˆ‡å›°éš¾ï¼',
                'çŸ¥è¯†å°±æ˜¯æœ€å¼ºå¤§çš„é­”æ³•ï¼',
                'å’Œæœ‹å‹ä¸€èµ·å­¦ä¹ æ›´æœ‰è¶£ï¼',
                'åšæŒå°±æ˜¯èƒœåˆ©ï¼'
            ];
            
            tip.textContent = tips[Math.floor(Math.random() * tips.length)];
            loading.style.display = 'flex';
        }
        
        function hideGlobalLoading() {
            document.getElementById('global-loading').style.display = 'none';
        }
        
        function showFloatingText(text, type = 'info') {
            const floatingText = document.createElement('div');
            floatingText.className = `floating-text floating-${type}`;
            floatingText.textContent = text;
            
            document.body.appendChild(floatingText);
            
            // æ’­æ”¾åŠ¨ç”»
            setTimeout(() => {
                floatingText.classList.add('show');
            }, 10);
            
            // ç§»é™¤å…ƒç´ 
            setTimeout(() => {
                floatingText.remove();
            }, 2000);
        }
        
        function showLevelUpEffect(newLevel) {
            const levelUpDiv = document.createElement('div');
            levelUpDiv.className = 'level-up-effect';
            levelUpDiv.innerHTML = `
                <div class="level-up-content">
                    <div class="level-up-stars">â­â­â­</div>
                    <h2>å‡çº§äº†ï¼</h2>
                    <p>ç­‰çº§ ${newLevel}</p>
                </div>
            `;
            
            document.body.appendChild(levelUpDiv);
            
            setTimeout(() => {
                levelUpDiv.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                levelUpDiv.remove();
            }, 3000);
        }
        
        function playAchievementSound() {
            // æ’­æ”¾æˆå°±è§£é”éŸ³æ•ˆ
            // è¿™é‡Œåº”è¯¥æ’­æ”¾éŸ³é¢‘æ–‡ä»¶
            console.log('ğŸµ æˆå°±è§£é”éŸ³æ•ˆ');
        }
        
        function showErrorAndReload() {
            hideGlobalLoading();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-screen';
            errorDiv.innerHTML = `
                <div class="error-content">
                    <h2>ğŸ˜” å¯åŠ¨å¤±è´¥</h2>
                    <p>æ¸¸æˆæ— æ³•æ­£å¸¸å¯åŠ¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
                    <button class="primary-btn" onclick="location.reload()">é‡æ–°åŠ è½½</button>
                </div>
            `;
            
            document.body.appendChild(errorDiv);
        }
        
        // è®¾ç½®æŒ‰é’®äº‹ä»¶
        document.getElementById('settings-btn').addEventListener('click', function() {
            // æ‰“å¼€è®¾ç½®é¡µé¢
            if (window.parent && window.parent.NavigationManager) {
                window.parent.NavigationManager.navigateToPage('settings.html');
            }
        });
        
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€é”™è¯¯:', event.error);
        });
    </script>
</body>
</html>